<!doctype html>
<html lang="zh-TW">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chinese Learning Adventure</title>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Microsoft JhengHei', 'PMingLiU', 'PingFang TC', 'Heiti TC', 'Noto Sans CJK TC', sans-serif;
      height: 100%;
      overflow: hidden;
    }
    
    html {
      height: 100%;
    }
    
    * {
      box-sizing: border-box;
    }
    
    /* Login Screen Styles */
    .login-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }
    
    .login-container {
      background: white;
      border-radius: 24px;
      padding: 48px;
      box-shadow: 0 16px 48px rgba(0, 0, 0, 0.3);
      max-width: 400px;
      width: 90%;
      text-align: center;
    }
    
    .login-header {
      margin-bottom: 32px;
    }
    
    .login-title {
      font-size: 56px;
      color: #2d3748;
      margin: 0 0 12px 0;
      font-weight: 700;
    }
    
    .login-subtitle {
      font-size: 16px;
      color: #718096;
      margin: 0;
    }
    
    .login-form {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    
    .input-group {
      text-align: left;
    }
    
    .input-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 8px;
    }
    
    .login-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 16px;
      outline: none;
      transition: border-color 0.3s ease;
    }
    
    .login-input:focus {
      border-color: #667eea;
    }
    
    .login-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 16px 32px;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
    }
    
    .login-footer {
      font-size: 12px;
      color: #a0aec0;
      margin: 0;
    }
    
    .app-container {
      height: 100%;
      display: flex;
      flex-direction: column;
      background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%);
    }
    
    .content-area {
      flex: 1;
      overflow: hidden;
      padding: 0;
      padding-bottom: 80px;
    }
    
    .page-content {
      height: 100%;
    }

    /* Lesson Map Screen */
    .lesson-map-container {
      height: 100%;
      width: 100%;
      position: relative;
      overflow: hidden;
    }
    
    .map-background {
      filter: brightness(0.9);
      width: 100%;
      height: 100%;
    }
    
    .lesson-node {
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }
    
    .lesson-node:hover {
      transform: scale(1.1);
    }
    
    .node-circle {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.5);
      border: 4px solid white;
      margin: 0 auto 8px;
      position: relative;
    }
    
    .node-circle.locked {
      background: linear-gradient(135deg, #a0aec0 0%, #718096 100%);
      opacity: 0.6;
    }
    
    .node-circle.locked::after {
      content: '\1F512';
      position: absolute;
      bottom: -5px;
      right: -5px;
      font-size: 24px;
      background: white;
      border-radius: 50%;
      padding: 2px;
    }
    
    .node-icon {
      font-size: 40px;
    }
    
    .node-label {
      background: rgba(255, 255, 255, 0.95);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 700;
      color: #2d3748;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      display: inline-block;
    }

    /* Visual Novel Styles */
    .visual-novel-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 200px;
      background: url('https://i.pinimg.com/736x/4a/01/90/4a0190274d2cc5ce8933037acf2f6ec3.jpg') center/cover no-repeat;
      display: flex;
      flex-direction: column;
      z-index: 1;
    }
    
    .scene-header {
      background: rgba(0, 0, 0, 0.85);
      color: white;
      padding: 16px 20px;
      text-align: center;
      backdrop-filter: blur(8px);
      position: relative;
    }
    
    .back-btn {
      position: absolute;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 2px solid white;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    .back-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .scene-title {
      font-size: 24px;
      margin: 0 0 8px 0;
      font-weight: 700;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }
    
    .scene-subtitle {
      font-size: 16px;
      margin: 0;
      opacity: 0.95;
    }
    
    .characters-area {
      position: fixed;
      bottom: 300px;
      left: 0;
      right: 0;
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      padding: 20px;
      z-index: 998;
      height: 200px;
    }
    
    .character {
      width: 120px;
      height: 160px;
      position: relative;
      transition: all 0.3s ease;
      opacity: 0.6;
    }
    
    .character.speaking {
      opacity: 1;
      transform: scale(1.05);
    }
    
    .character-avatar {
      width: 100%;
      height: 100%;
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 80px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      position: relative;
      overflow: hidden;
    }
    
    .character-phin .character-avatar {
      background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
    }
    
    .character-david .character-avatar {
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
    }
    
    .character-name {
      position: absolute;
      bottom: -30px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      white-space: nowrap;
    }
    
    .character-emoji {
      position: absolute;
      top: -36px;
      right: -36px;
      font-size: 72px;
      animation: emojiPop 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 10;
      filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
      transform-origin: center center;
    }
    
    @keyframes emojiPop {
      0% {
        transform: scale(0) rotate(-15deg);
        opacity: 0;
      }
      50% {
        transform: scale(1.3) rotate(5deg);
      }
      70% {
        transform: scale(0.9) rotate(-3deg);
      }
      100% {
        transform: scale(1) rotate(0deg);
        opacity: 1;
      }
    }
    
    .dialogue-box {
      position: fixed;
      bottom: 80px;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 24px;
      min-height: 120px;
      z-index: 999;
    }
    
    .speaker-name {
      font-size: 18px;
      font-weight: 600;
      color: #ffa500;
      margin-bottom: 8px;
    }
    
    .dialogue-text {
      font-size: 16px;
      line-height: 1.6;
      margin-bottom: 16px;
    }
    
    .chinese-text {
      font-size: 20px;
      color: #ffeb3b;
      margin-bottom: 8px;
    }
    
    .pinyin-text {
      font-size: 14px;
      color: #81c784;
      font-style: normal;
      font-family: Arial, sans-serif;
      margin-bottom: 8px;
      letter-spacing: 0.5px;
    }
    
    .english-text {
      font-size: 16px;
      color: white;
    }
    
    .continue-btn {
      position: absolute;
      bottom: 24px;
      right: 24px;
      background: #ffa500;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4), 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .continue-btn:hover {
      background: #ff8c00;
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.5), 0 3px 6px rgba(0, 0, 0, 0.4);
    }
    
    .save-dialogue-btn {
      position: absolute;
      top: 24px;
      right: 24px;
      background: rgba(0, 0, 0, 0.3);
      color: rgba(255, 215, 0, 0.3);
      border: 2px solid rgba(255, 215, 0, 0.2);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      line-height: 1;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.5;
    }
    
    .save-dialogue-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 215, 0, 0.4);
      transform: scale(1.1);
      opacity: 0.8;
    }
    
    .save-dialogue-btn.saved {
      background: rgba(255, 215, 0, 0.3);
      border-color: #ffd700;
      color: #ffd700;
      opacity: 1;
    }

    /* Quiz Options in Dialogue */
    .dialogue-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 16px;
    }
    
    .dialogue-option-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.5);
      padding: 16px;
      border-radius: 12px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }
    
    .dialogue-option-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: white;
      transform: scale(1.05);
    }

    /* World Page Styles */
    .world-container {
      height: 100%;
      position: relative;
      overflow: visible;
    }
    
    .world-map {
      width: 100%;
      height: 100%;
      position: relative;
    }
    
    .map-stage {
      position: absolute;
      width: 100px;
      height: 100px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
      overflow: visible;
    }
    
    .map-stage:hover {
      transform: scale(1.1);
    }
    
    .stage-label {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 5px 12px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 700;
      white-space: nowrap;
      border: 2px solid #2d3748;
      text-align: center;
      z-index: 1000;
      display: inline-block;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .stage-timer {
      font-size: 11px;
      color: #ff0000;
      margin-top: 2px;
      font-weight: 700;
    }
    
    .npc-character {
      position: absolute;
      width: 60px;
      height: 60px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      transition: all 2s ease-in-out;
    }

    /* Dictionary Page Styles */
    .dictionary-container {
      max-width: 800px;
      margin: 20px auto;
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      height: calc(100% - 40px);
      display: flex;
      flex-direction: column;
    }
    
    .dict-header {
      margin-bottom: 20px;
      flex-shrink: 0;
    }
    
    .dict-title {
      font-size: 28px;
      font-weight: 700;
      color: #2d3748;
      margin: 0 0 16px 0;
      text-align: center;
    }
    
    .dict-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      border-bottom: 2px solid #e2e8f0;
      padding-bottom: 0;
    }
    
    .dict-tab {
      flex: 1;
      padding: 12px 16px;
      border: none;
      background: transparent;
      color: #718096;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border-bottom: 3px solid transparent;
      position: relative;
      bottom: -2px;
    }
    
    .dict-tab:hover {
      color: #667eea;
      background: rgba(102, 126, 234, 0.05);
    }
    
    .dict-tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
      background: rgba(102, 126, 234, 0.1);
    }
    
    .dict-search {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 16px;
      outline: none;
    }
    
    .dict-search:focus {
      border-color: #667eea;
    }
    
    .dict-tab-content {
      flex: 1;
      overflow-y: auto;
      margin-top: 16px;
    }
    
    .word-entry {
      display: flex;
      align-items: center;
      padding: 16px;
      border-bottom: 1px solid #e2e8f0;
      transition: background 0.2s ease;
    }
    
    .word-entry:hover {
      background: #f7fafc;
    }
    
    .word-entry:last-child {
      border-bottom: none;
    }
    
    .word-chinese {
      font-size: 24px;
      font-weight: 600;
      color: #2d3748;
      min-width: 80px;
    }
    
    .word-pinyin {
      font-size: 16px;
      color: #81c784;
      font-style: italic;
      min-width: 120px;
      margin-left: 16px;
    }
    
    .word-english {
      font-size: 16px;
      color: #718096;
      flex: 1;
      margin-left: 16px;
    }
    
    .dialogue-entry {
      padding: 20px;
      border-bottom: 1px solid #e2e8f0;
      background: #f7fafc;
      margin-bottom: 12px;
      border-radius: 12px;
      position: relative;
    }
    
    .dialogue-speaker {
      font-size: 16px;
      font-weight: 700;
      color: #667eea;
      margin-bottom: 12px;
    }
    
    .dialogue-content {
      margin-bottom: 8px;
    }
    
    .unsave-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      background: #f44336;
      color: white;
      border: none;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 16px;
      line-height: 1;
      transition: all 0.3s ease;
    }
    
    .unsave-btn:hover {
      background: #d32f2f;
      transform: scale(1.1);
    }
    
    .slang-entry {
      padding: 20px;
      border-bottom: 1px solid #e2e8f0;
      background: linear-gradient(135deg, #f7fafc 0%, #ffffff 100%);
      margin-bottom: 12px;
      border-radius: 12px;
      transition: all 0.3s ease;
    }
    
    .slang-entry:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .slang-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .slang-badge {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .slang-example {
      margin-top: 12px;
      padding: 12px;
      background: rgba(102, 126, 234, 0.05);
      border-left: 3px solid #667eea;
      border-radius: 6px;
    }
    
    .example-chinese {
      font-size: 16px;
      color: #2d3748;
      margin-bottom: 4px;
      font-weight: 600;
    }
    
    .example-english {
      font-size: 14px;
      color: #718096;
      font-style: italic;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
    }

    /* Explore Page Styles */
    .explore-container {
      padding: 20px;
      overflow-y: auto;
      height: 100%;
      max-width: 1200px;
      margin: 0 auto;
    }

    .explore-title {
      color: white;
      font-size: 32px;
      text-align: center;
      margin: 0 0 32px 0;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .explore-section {
      margin-bottom: 40px;
    }

    .section-title {
      color: white;
      font-size: 24px;
      font-weight: 600;
      margin: 0 0 20px 0;
      text-align: center;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .horizontal-scroll {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 20px;
      padding: 0;
      max-width: 100%;
    }

    .content-card {
      background: white;
      border-radius: 16px;
      padding: 24px 20px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .content-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
    }

    .card-image {
      font-size: 56px;
      margin-bottom: 16px;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
      color: #2d3748;
    }

    /* HOME PAGE WITH ROOM STYLES */
    .player-room-container {
      height: 100%;
      width: 100%;
      position: relative;
      overflow: hidden;
    }
    
    .room-scene {
      width: 100%;
      height: 100%;
      background-image: linear-gradient(rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0.3)), url('https://imgcdn.stablediffusionweb.com/2025/10/3/a4bfc20f-ef48-4ed3-b785-2e3826033f0b.jpg');
      background-position: center;
      background-size: cover;
      background-repeat: no-repeat;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .room-object {
      position: absolute;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }
    
    .room-object:hover .object-icon {
      transform: scale(1.1);
    }
    
    .object-icon {
      font-size: 64px;
      margin-bottom: 8px;
      filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
    }
    
    .object-label {
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 8px 16px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      white-space: nowrap;
    }
    
    .avatar-display {
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }
    
    .room-avatar {
      width: 280px;
      height: 420px;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      position: relative;
      margin: 0 auto 16px;
      filter: drop-shadow(0 12px 40px rgba(0, 0, 0, 0.4));
    }
    
    .rpg-character {
      width: 100%;
      height: 100%;
      position: relative;
    }
    
    .computer-object {
      right: 15%;
      top: 20%;
    }
    
    .wardrobe-object {
      left: 10%;
      top: 15%;
    }
    
    .bookshelf-object {
      right: 10%;
      bottom: 25%;
    }
    
    .door-object {
      left: 15%;
      bottom: 15%;
    }
    
    .room-currency {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(0, 0, 0, 0.8);
      border: 2px solid #ffd700;
      border-radius: 20px;
      padding: 12px 24px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .currency-icon {
      font-size: 24px;
    }
    
    .currency-amount {
      font-size: 24px;
      font-weight: 700;
      color: #ffd700;
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    
    .modal-content {
      background: white;
      border-radius: 24px;
      padding: 32px;
      max-width: 750px;
      width: 90%;
      max-height: 80%;
      overflow-y: auto;
      position: relative;
    }
    
    .wardrobe-modal {
      max-height: 85%;
      overflow-y: auto;
    }
    
    .wardrobe-section {
      margin-bottom: 20px;
    }
    
    .wardrobe-section h3 {
      margin: 12px 0 8px;
      color: #2d3748;
      font-size: 15px;
      font-weight: 600;
    }
    
    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: #f44336;
      color: white;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      line-height: 1;
    }
    
    .modal-title {
      font-size: 24px;
      font-weight: 700;
      color: #2d3748;
      margin: 0 0 24px 0;
      text-align: center;
    }
    
    .customization-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-bottom: 12px;
    }
    
    .custom-option {
      padding: 10px 8px;
      border: 3px solid #e2e8f0;
      border-radius: 12px;
      cursor: pointer;
      text-align: center;
      transition: all 0.3s ease;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 90px;
    }
    
    .custom-option:hover {
      border-color: #667eea;
      transform: scale(1.05);
    }
    
    .custom-option.selected {
      border-color: #667eea;
      background: #f0f4ff;
    }
    
    .custom-option.locked {
      opacity: 0.4;
      cursor: not-allowed;
    }
    
    .custom-option.locked:hover {
      transform: none;
      border-color: #e2e8f0;
    }
    
    .option-visual {
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 6px;
    }
    
    .option-emoji {
      font-size: 36px;
    }
    
    .option-color-swatch {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 3px solid #2c3e50;
    }
    
    .option-price {
      font-size: 11px;
      color: #718096;
      font-weight: 600;
      margin-top: 4px;
    }
    
    .stats-grid {
      display: grid;
      gap: 16px;
    }
    
    .stat-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      background: #f7fafc;
      border-radius: 12px;
    }
    
    .stat-label {
      font-size: 16px;
      color: #718096;
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: #2d3748;
    }

    .stats-section {
      margin-bottom: 32px;
    }

    .stats-section h3 {
      font-size: 20px;
      color: #2d3748;
      margin: 0 0 16px 0;
      padding-bottom: 8px;
      border-bottom: 2px solid #e2e8f0;
    }

    .stats-columns {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    @media (max-width: 768px) {
      .stats-columns {
        grid-template-columns: 1fr;
      }
    }

    .stat-bar {
      margin-bottom: 16px;
    }

    .stat-bar-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: 14px;
    }

    .stat-bar-label {
      color: #4a5568;
      font-weight: 600;
    }

    .stat-bar-value {
      color: #2d3748;
      font-weight: 700;
    }

    .stat-bar-track {
      height: 10px;
      background: #e2e8f0;
      border-radius: 10px;
      overflow: hidden;
    }

    .stat-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      border-radius: 10px;
      transition: width 0.3s ease;
    }

    .achievement-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: #f7fafc;
      border-radius: 12px;
      margin-bottom: 12px;
    }
    
    .achievement-icon {
      font-size: 48px;
    }
    
    .achievement-info {
      flex: 1;
    }
    
    .achievement-name {
      font-size: 18px;
      font-weight: 600;
      color: #2d3748;
      margin: 0 0 4px 0;
    }
    
    .achievement-desc {
      font-size: 14px;
      color: #718096;
      margin: 0;
    }
    
    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-around;
      padding: 12px 0;
      z-index: 1000;
    }
    
    .nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      padding: 8px;
      border: none;
      background: none;
      transition: all 0.3s ease;
      color: #718096;
    }
    
    .nav-item:hover {
      color: #667eea;
    }
    
    .nav-item.active {
      color: #667eea;
    }
    
    .nav-icon {
      font-size: 24px;
    }
    
    .nav-label {
      font-size: 12px;
      font-weight: 500;
    }
    
    .hidden {
      display: none;
    }
    
    /* Character Preview in Modal */
    .character-preview {
      width: 180px;
      height: 280px;
      margin: 0 auto 24px;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      filter: drop-shadow(0 8px 24px rgba(0, 0, 0, 0.2));
    }
    
    /* Image Moment Styles */
    .image-moment {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      text-align: center;
    }
    
    .image-moment img {
      max-width: 600px;
      width: 90vw;
      border-radius: 24px;
      box-shadow: 0 16px 48px rgba(0,0,0,0.4);
      display: block;
    }
    
    .image-moment .continue-btn {
      position: relative;
      bottom: auto;
      right: auto;
      margin-top: 20px;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div id="login-screen" class="login-screen">
   <div class="login-container">
    <div class="login-header">
     <h1 class="login-title">üêª <span id="login-icon-1"></span> Lango <span id="login-icon-2"></span></h1>
     <p class="login-subtitle">The FUN Way to Learn!</p>
    </div>
    <div class="login-form">
     <div class="input-group"><label for="username-input" class="input-label">Username</label> <input type="text" id="username-input" class="login-input" placeholder="Enter your username">
     </div><button class="login-btn" onclick="login()">Start Learning</button>
    </div>
   </div>
  </div>
  <div class="app-container hidden" id="main-app">
   <div class="content-area"><!-- Lesson Map Screen -->
    <div id="learn-select-page" class="page-content">
     <div class="lesson-map-container">
      <div class="map-background" style="background: url('https://www.ntu.edu.tw/images/about/ntumap.jpg') center/cover no-repeat; width: 100%; height: 100%; position: relative;"><!-- Chapter Title Banner -->
       <div style="position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(12px); padding: 12px 32px; border-radius: 16px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4); z-index: 100; border: 2px solid rgba(255, 165, 0, 0.3);">
        <div style="text-align: center;">
         <div style="font-size: 12px; color: #ffa500; font-weight: 600; letter-spacing: 2px; margin-bottom: 3px;">
          CHAPTER N
         </div>
         <div style="font-size: 18px; color: white; font-weight: 700; text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);">
          How I Met Your Father
         </div>
        </div>
       </div><!-- Lesson Nodes -->
       <div class="lesson-node" style="position: absolute; left: 20%; top: 25%;" onclick="startLesson('greetings')">
        <div class="node-circle">
         <div class="node-icon" id="lesson-icon-greetings"></div>
        </div>
        <div class="node-label">
         Lesson 1-1
        </div>
       </div>
       <div class="lesson-node" style="position: absolute; left: 50%; top: 40%;" onclick="startLesson('numbers')">
        <div class="node-circle">
         <div class="node-icon" id="lesson-icon-numbers"></div>
        </div>
        <div class="node-label">
         Lesson 1-2
        </div>
       </div>
       <div class="lesson-node" style="position: absolute; left: 70%; top: 60%;" onclick="startLesson('food')">
        <div class="node-circle locked">
         <div class="node-icon" id="lesson-icon-food"></div>
        </div>
        <div class="node-label">
         Lesson 1-3.1
        </div>
       </div>
       <div class="lesson-node" style="position: absolute; left: 30%; top: 70%;" onclick="startLesson('shopping')">
        <div class="node-circle locked">
         <div class="node-icon" id="lesson-icon-shopping"></div>
        </div>
        <div class="node-label">
         Lesson 1-4
        </div>
       </div>
       <div class="lesson-node" style="position: absolute; left: 80%; top: 30%;" onclick="startLesson('directions')">
        <div class="node-circle locked">
         <div class="node-icon" id="lesson-icon-directions"></div>
        </div>
        <div class="node-label">
         Lesson 1-3.2
        </div>
       </div>
      </div>
     </div>
    </div><!-- Learn Page -->
    <div id="learn-page" class="page-content hidden"><!-- Visual Novel Container -->
     <div class="visual-novel-container" id="visual-novel">
      <div class="scene-header"><button class="back-btn" onclick="backToLessons()"><span id="back-arrow"></span> Back</button>
       <h1 class="scene-title" id="scene-title">Coffee Shop Conversation</h1>
       <p class="scene-subtitle" id="scene-subtitle">Learn greetings and introductions</p>
      </div>
      <div class="characters-area" id="characters-area">
       <div class="character character-david speaking" id="character-david">
        <div class="character-avatar" id="char-david-avatar"></div>
        <div class="character-name">
         David (Â§ßË°õ)
        </div>
       </div>
       <div class="character character-phin" id="character-phin">
        <div class="character-avatar" id="char-phin-avatar"></div>
        <div class="character-name">
         Phin
        </div>
       </div>
      </div>
      <div class="dialogue-box" id="dialogue-box">
       <div class="speaker-name" id="speaker-name">
        David (Â§ßË°õ)
       </div>
       <div class="dialogue-text" id="dialogue-content">
        <div class="chinese-text" id="chinese-text">
         ‰Ω†Â•ΩÔºÅÊàëÂè´Â§ßË°õ„ÄÇ
        </div>
        <div class="pinyin-text" id="pinyin-text">
         N«ê h«éo! W«í ji√†o D√†w√®i.
        </div>
        <div class="english-text" id="english-text">
         Hello! My name is David.
        </div>
       </div><button class="continue-btn" id="continue-btn" onclick="continueStory()">Continue <span id="arrow-icon"></span></button>
      </div>
     </div>
    </div><!-- World Page -->
    <div id="world-page" class="page-content hidden">
     <div class="world-container">
      <div class="world-map" id="world-map" style="background: url('https://maps-taipei.com/img/0/taipei-street-map.jpg') center/cover no-repeat;">
       <div style="position: absolute; top: 20px; left: 50%; transform: translateX(-50%); display: flex; align-items: center; gap: 8px; background: rgba(0, 0, 0, 0.8); border: 2px solid #ffd700; border-radius: 20px; padding: 12px 24px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); z-index: 10;"><span id="world-icon-currency" style="font-size: 24px;"></span> <span id="world-yuan-bao" style="font-size: 24px; font-weight: 700; color: #ffd700;">100</span></div>
       <div class="map-stage" style="left: 20%; top: 30%; border: 3px solid black;" id="world-stage-market" onclick="openShoppingGame()"></div>
       <div class="stage-label" style="left: 20%; top: calc(30% + 120px);">
        Market
        <div class="stage-timer" id="timer-market">-2h:30m</div>
       </div>

       <div class="map-stage" style="left: 50%; top: 50%; border: 3px solid black;" id="world-stage-restaurant" onclick="openRestaurantGame()"></div>
       <div class="stage-label" style="left: 50%; top: calc(50% + 120px);">
        Restaurant
        <div class="stage-timer" id="timer-restaurant">-1h:45m</div>
       </div>

       <div class="map-stage" style="right: 20%; top: 70%; border: 3px solid black;" id="world-stage-park" onclick="openParkGame()"></div>
       <div class="stage-label" style="left: 80%; top: calc(70% + 120px);">
        Park
        <div class="stage-timer" id="timer-park">-3h:15m</div>
       </div>
       <div class="npc-character" id="npc1"></div>
       <div class="npc-character" id="npc2"></div>
       <div class="npc-character" id="npc3"></div>
       <div class="npc-character" id="npc4"></div>
      </div>
     </div>
    </div><!-- Dictionary Page -->
    <div id="dictionary-page" class="page-content hidden">
     <div class="dictionary-container">
      <div class="dict-header">
       <h1 class="dict-title"><span id="dict-icon"></span> Dictionary</h1><!-- Dictionary Tabs -->
       <div class="dict-tabs"><button class="dict-tab active" onclick="switchDictTab('learned')">Learned</button> <button class="dict-tab" onclick="switchDictTab('saved')">Saved</button> <button class="dict-tab" onclick="switchDictTab('slangs')">Slangs</button> <button class="dict-tab" onclick="switchDictTab('memes')">Meme Pronunciation</button> <button class="dict-tab" onclick="switchDictTab('dictionary')">Dictionary</button>
       </div><input type="text" class="dict-search" id="dict-search" placeholder="Search words..." onkeyup="searchDictionary()">
      </div><!-- Dictionary Tab Content -->
      <div id="dict-tab-dictionary" class="dict-tab-content hidden">
       <div class="word-entry">
        <div class="word-chinese">
         ‰Ω†Â•Ω
        </div>
        <div class="word-pinyin">
         n«ê h«éo
        </div>
        <div class="word-english">
         hello <span style="display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; background: rgba(255, 215, 0, 0.15); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 50%; cursor: pointer; margin-left: 8px; transition: all 0.3s ease; vertical-align: middle;" onmouseover="this.style.background='rgba(255, 215, 0, 0.3)'; this.style.transform='scale(1.1)'" onmouseout="this.style.background='rgba(255, 215, 0, 0.15)'; this.style.transform='scale(1)'">
          <svg width="10" height="10" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
           <path d="M11 5L6 9H2V15H6L11 19V5Z" fill="#ffd700" stroke="#ffd700" stroke-width="2" stroke-linejoin="round" /><path d="M15.54 8.46C16.4774 9.39764 17.0039 10.6692 17.0039 11.995C17.0039 13.3208 16.4774 14.5924 15.54 15.53" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /><path d="M19.07 4.93C20.9447 6.80528 21.9979 9.34836 21.9979 12C21.9979 14.6516 20.9447 17.1947 19.07 19.07" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          </svg></span>
        </div>
       </div>
       <div class="word-entry">
        <div class="word-chinese">
         Ë¨ùË¨ù
        </div>
        <div class="word-pinyin">
         xi√® xie
        </div>
        <div class="word-english">
         thank you <span style="display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; background: rgba(255, 215, 0, 0.15); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 50%; cursor: pointer; margin-left: 8px; transition: all 0.3s ease; vertical-align: middle;" onmouseover="this.style.background='rgba(255, 215, 0, 0.3)'; this.style.transform='scale(1.1)'" onmouseout="this.style.background='rgba(255, 215, 0, 0.15)'; this.style.transform='scale(1)'">
          <svg width="10" height="10" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
           <path d="M11 5L6 9H2V15H6L11 19V5Z" fill="#ffd700" stroke="#ffd700" stroke-width="2" stroke-linejoin="round" /><path d="M15.54 8.46C16.4774 9.39764 17.0039 10.6692 17.0039 11.995C17.0039 13.3208 16.4774 14.5924 15.54 15.53" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /><path d="M19.07 4.93C20.9447 6.80528 21.9979 9.34836 21.9979 12C21.9979 14.6516 20.9447 17.1947 19.07 19.07" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          </svg></span>
        </div>
       </div>
       <div class="word-entry">
        <div class="word-chinese">
         ÂÜçË¶ã
        </div>
        <div class="word-pinyin">
         z√†i ji√†n
        </div>
        <div class="word-english">
         goodbye <span style="display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; background: rgba(255, 215, 0, 0.15); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 50%; cursor: pointer; margin-left: 8px; transition: all 0.3s ease; vertical-align: middle;" onmouseover="this.style.background='rgba(255, 215, 0, 0.3)'; this.style.transform='scale(1.1)'" onmouseout="this.style.background='rgba(255, 215, 0, 0.15)'; this.style.transform='scale(1)'">
          <svg width="10" height="10" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
           <path d="M11 5L6 9H2V15H6L11 19V5Z" fill="#ffd700" stroke="#ffd700" stroke-width="2" stroke-linejoin="round" /><path d="M15.54 8.46C16.4774 9.39764 17.0039 10.6692 17.0039 11.995C17.0039 13.3208 16.4774 14.5924 15.54 15.53" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /><path d="M19.07 4.93C20.9447 6.80528 21.9979 9.34836 21.9979 12C21.9979 14.6516 20.9447 17.1947 19.07 19.07" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          </svg></span>
        </div>
       </div>
       <div class="word-entry">
        <div class="word-chinese">
         Â∞ç‰∏çËµ∑
        </div>
        <div class="word-pinyin">
         du√¨ bu q«ê
        </div>
        <div class="word-english">
         sorry <span style="display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; background: rgba(255, 215, 0, 0.15); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 50%; cursor: pointer; margin-left: 8px; transition: all 0.3s ease; vertical-align: middle;" onmouseover="this.style.background='rgba(255, 215, 0, 0.3)'; this.style.transform='scale(1.1)'" onmouseout="this.style.background='rgba(255, 215, 0, 0.15)'; this.style.transform='scale(1)'">
          <svg width="10" height="10" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
           <path d="M11 5L6 9H2V15H6L11 19V5Z" fill="#ffd700" stroke="#ffd700" stroke-width="2" stroke-linejoin="round" /><path d="M15.54 8.46C16.4774 9.39764 17.0039 10.6692 17.0039 11.995C17.0039 13.3208 16.4774 14.5924 15.54 15.53" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /><path d="M19.07 4.93C20.9447 6.80528 21.9979 9.34836 21.9979 12C21.9979 14.6516 20.9447 17.1947 19.07 19.07" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          </svg></span>
        </div>
       </div>
       <div class="word-entry">
        <div class="word-chinese">
         Ë´ã
        </div>
        <div class="word-pinyin">
         q«êng
        </div>
        <div class="word-english">
         please <span style="display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; background: rgba(255, 215, 0, 0.15); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 50%; cursor: pointer; margin-left: 8px; transition: all 0.3s ease; vertical-align: middle;" onmouseover="this.style.background='rgba(255, 215, 0, 0.3)'; this.style.transform='scale(1.1)'" onmouseout="this.style.background='rgba(255, 215, 0, 0.15)'; this.style.transform='scale(1)'">
          <svg width="10" height="10" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
           <path d="M11 5L6 9H2V15H6L11 19V5Z" fill="#ffd700" stroke="#ffd700" stroke-width="2" stroke-linejoin="round" /><path d="M15.54 8.46C16.4774 9.39764 17.0039 10.6692 17.0039 11.995C17.0039 13.3208 16.4774 14.5924 15.54 15.53" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /><path d="M19.07 4.93C20.9447 6.80528 21.9979 9.34836 21.9979 12C21.9979 14.6516 20.9447 17.1947 19.07 19.07" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          </svg></span>
        </div>
       </div>
       <div class="word-entry">
        <div class="word-chinese">
         Ê∞¥
        </div>
        <div class="word-pinyin">
         shu«ê
        </div>
        <div class="word-english">
         water <span style="display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; background: rgba(255, 215, 0, 0.15); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 50%; cursor: pointer; margin-left: 8px; transition: all 0.3s ease; vertical-align: middle;" onmouseover="this.style.background='rgba(255, 215, 0, 0.3)'; this.style.transform='scale(1.1)'" onmouseout="this.style.background='rgba(255, 215, 0, 0.15)'; this.style.transform='scale(1)'">
          <svg width="10" height="10" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
           <path d="M11 5L6 9H2V15H6L11 19V5Z" fill="#ffd700" stroke="#ffd700" stroke-width="2" stroke-linejoin="round" /><path d="M15.54 8.46C16.4774 9.39764 17.0039 10.6692 17.0039 11.995C17.0039 13.3208 16.4774 14.5924 15.54 15.53" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /><path d="M19.07 4.93C20.9447 6.80528 21.9979 9.34836 21.9979 12C21.9979 14.6516 20.9447 17.1947 19.07 19.07" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          </svg></span>
        </div>
       </div>
       <div class="word-entry">
        <div class="word-chinese">
         È£Ø
        </div>
        <div class="word-pinyin">
         f√†n
        </div>
        <div class="word-english">
         rice, meal <span style="display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; background: rgba(255, 215, 0, 0.15); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 50%; cursor: pointer; margin-left: 8px; transition: all 0.3s ease; vertical-align: middle;" onmouseover="this.style.background='rgba(255, 215, 0, 0.3)'; this.style.transform='scale(1.1)'" onmouseout="this.style.background='rgba(255, 215, 0, 0.15)'; this.style.transform='scale(1)'">
          <svg width="10" height="10" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
           <path d="M11 5L6 9H2V15H6L11 19V5Z" fill="#ffd700" stroke="#ffd700" stroke-width="2" stroke-linejoin="round" /><path d="M15.54 8.46C16.4774 9.39764 17.0039 10.6692 17.0039 11.995C17.0039 13.3208 16.4774 14.5924 15.54 15.53" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /><path d="M19.07 4.93C20.9447 6.80528 21.9979 9.34836 21.9979 12C21.9979 14.6516 20.9447 17.1947 19.07 19.07" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          </svg></span>
        </div>
       </div>
       <div class="word-entry">
        <div class="word-chinese">
         È∫µ
        </div>
        <div class="word-pinyin">
         mi√†n
        </div>
        <div class="word-english">
         noodles <span style="display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; background: rgba(255, 215, 0, 0.15); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 50%; cursor: pointer; margin-left: 8px; transition: all 0.3s ease; vertical-align: middle;" onmouseover="this.style.background='rgba(255, 215, 0, 0.3)'; this.style.transform='scale(1.1)'" onmouseout="this.style.background='rgba(255, 215, 0, 0.15)'; this.style.transform='scale(1)'">
          <svg width="10" height="10" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
           <path d="M11 5L6 9H2V15H6L11 19V5Z" fill="#ffd700" stroke="#ffd700" stroke-width="2" stroke-linejoin="round" /><path d="M15.54 8.46C16.4774 9.39764 17.0039 10.6692 17.0039 11.995C17.0039 13.3208 16.4774 14.5924 15.54 15.53" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /><path d="M19.07 4.93C20.9447 6.80528 21.9979 9.34836 21.9979 12C21.9979 14.6516 20.9447 17.1947 19.07 19.07" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          </svg></span>
        </div>
       </div>
       <div class="word-entry">
        <div class="word-chinese">
         Ëå∂
        </div>
        <div class="word-pinyin">
         ch√°
        </div>
        <div class="word-english">
         tea <span style="display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; background: rgba(255, 215, 0, 0.15); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 50%; cursor: pointer; margin-left: 8px; transition: all 0.3s ease; vertical-align: middle;" onmouseover="this.style.background='rgba(255, 215, 0, 0.3)'; this.style.transform='scale(1.1)'" onmouseout="this.style.background='rgba(255, 215, 0, 0.15)'; this.style.transform='scale(1)'">
          <svg width="10" height="10" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
           <path d="M11 5L6 9H2V15H6L11 19V5Z" fill="#ffd700" stroke="#ffd700" stroke-width="2" stroke-linejoin="round" /><path d="M15.54 8.46C16.4774 9.39764 17.0039 10.6692 17.0039 11.995C17.0039 13.3208 16.4774 14.5924 15.54 15.53" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /><path d="M19.07 4.93C20.9447 6.80528 21.9979 9.34836 21.9979 12C21.9979 14.6516 20.9447 17.1947 19.07 19.07" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          </svg></span>
        </div>
       </div>
       <div class="word-entry">
        <div class="word-chinese">
         ÂíñÂï°
        </div>
        <div class="word-pinyin">
         kƒÅ fƒìi
        </div>
        <div class="word-english">
         coffee <span style="display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; background: rgba(255, 215, 0, 0.15); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 50%; cursor: pointer; margin-left: 8px; transition: all 0.3s ease; vertical-align: middle;" onmouseover="this.style.background='rgba(255, 215, 0, 0.3)'; this.style.transform='scale(1.1)'" onmouseout="this.style.background='rgba(255, 215, 0, 0.15)'; this.style.transform='scale(1)'">
          <svg width="10" height="10" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
           <path d="M11 5L6 9H2V15H6L11 19V5Z" fill="#ffd700" stroke="#ffd700" stroke-width="2" stroke-linejoin="round" /><path d="M15.54 8.46C16.4774 9.39764 17.0039 10.6692 17.0039 11.995C17.0039 13.3208 16.4774 14.5924 15.54 15.53" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /><path d="M19.07 4.93C20.9447 6.80528 21.9979 9.34836 21.9979 12C21.9979 14.6516 20.9447 17.1947 19.07 19.07" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          </svg></span>
        </div>
       </div>
       <div class="word-entry">
        <div class="word-chinese">
         Â§öÂ∞ëÈå¢
        </div>
        <div class="word-pinyin">
         du≈ç sh«éo qi√°n
        </div>
        <div class="word-english">
         how much money <span style="display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; background: rgba(255, 215, 0, 0.15); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 50%; cursor: pointer; margin-left: 8px; transition: all 0.3s ease; vertical-align: middle;" onmouseover="this.style.background='rgba(255, 215, 0, 0.3)'; this.style.transform='scale(1.1)'" onmouseout="this.style.background='rgba(255, 215, 0, 0.15)'; this.style.transform='scale(1)'">
          <svg width="10" height="10" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
           <path d="M11 5L6 9H2V15H6L11 19V5Z" fill="#ffd700" stroke="#ffd700" stroke-width="2" stroke-linejoin="round" /><path d="M15.54 8.46C16.4774 9.39764 17.0039 10.6692 17.0039 11.995C17.0039 13.3208 16.4774 14.5924 15.54 15.53" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /><path d="M19.07 4.93C20.9447 6.80528 21.9979 9.34836 21.9979 12C21.9979 14.6516 20.9447 17.1947 19.07 19.07" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          </svg></span>
        </div>
       </div>
       <div class="word-entry">
        <div class="word-chinese">
         Ë≤¥
        </div>
        <div class="word-pinyin">
         gu√¨
        </div>
        <div class="word-english">
         expensive <span style="display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; background: rgba(255, 215, 0, 0.15); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 50%; cursor: pointer; margin-left: 8px; transition: all 0.3s ease; vertical-align: middle;" onmouseover="this.style.background='rgba(255, 215, 0, 0.3)'; this.style.transform='scale(1.1)'" onmouseout="this.style.background='rgba(255, 215, 0, 0.15)'; this.style.transform='scale(1)'">
          <svg width="10" height="10" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
           <path d="M11 5L6 9H2V15H6L11 19V5Z" fill="#ffd700" stroke="#ffd700" stroke-width="2" stroke-linejoin="round" /><path d="M15.54 8.46C16.4774 9.39764 17.0039 10.6692 17.0039 11.995C17.0039 13.3208 16.4774 14.5924 15.54 15.53" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /><path d="M19.07 4.93C20.9447 6.80528 21.9979 9.34836 21.9979 12C21.9979 14.6516 20.9447 17.1947 19.07 19.07" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          </svg></span>
        </div>
       </div>
       <div class="word-entry">
        <div class="word-chinese">
         ‰æøÂÆú
        </div>
        <div class="word-pinyin">
         pi√°n yi
        </div>
        <div class="word-english">
         cheap <span style="display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; background: rgba(255, 215, 0, 0.15); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 50%; cursor: pointer; margin-left: 8px; transition: all 0.3s ease; vertical-align: middle;" onmouseover="this.style.background='rgba(255, 215, 0, 0.3)'; this.style.transform='scale(1.1)'" onmouseout="this.style.background='rgba(255, 215, 0, 0.15)'; this.style.transform='scale(1)'">
          <svg width="10" height="10" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
           <path d="M11 5L6 9H2V15H6L11 19V5Z" fill="#ffd700" stroke="#ffd700" stroke-width="2" stroke-linejoin="round" /><path d="M15.54 8.46C16.4774 9.39764 17.0039 10.6692 17.0039 11.995C17.0039 13.3208 16.4774 14.5924 15.54 15.53" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /><path d="M19.07 4.93C20.9447 6.80528 21.9979 9.34836 21.9979 12C21.9979 14.6516 20.9447 17.1947 19.07 19.07" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          </svg></span>
        </div>
       </div>
       <div class="word-entry">
        <div class="word-chinese">
         Â•ΩÂêÉ
        </div>
        <div class="word-pinyin">
         h«éo chƒ´
        </div>
        <div class="word-english">
         delicious <span style="display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; background: rgba(255, 215, 0, 0.15); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 50%; cursor: pointer; margin-left: 8px; transition: all 0.3s ease; vertical-align: middle;" onmouseover="this.style.background='rgba(255, 215, 0, 0.3)'; this.style.transform='scale(1.1)'" onmouseout="this.style.background='rgba(255, 215, 0, 0.15)'; this.style.transform='scale(1)'">
          <svg width="10" height="10" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
           <path d="M11 5L6 9H2V15H6L11 19V5Z" fill="#ffd700" stroke="#ffd700" stroke-width="2" stroke-linejoin="round" /><path d="M15.54 8.46C16.4774 9.39764 17.0039 10.6692 17.0039 11.995C17.0039 13.3208 16.4774 14.5924 15.54 15.53" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /><path d="M19.07 4.93C20.9447 6.80528 21.9979 9.34836 21.9979 12C21.9979 14.6516 20.9447 17.1947 19.07 19.07" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          </svg></span>
        </div>
       </div>
       <div class="word-entry">
        <div class="word-chinese">
         ÊúãÂèã
        </div>
        <div class="word-pinyin">
         p√©ng you
        </div>
        <div class="word-english">
         friend <span style="display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; background: rgba(255, 215, 0, 0.15); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 50%; cursor: pointer; margin-left: 8px; transition: all 0.3s ease; vertical-align: middle;" onmouseover="this.style.background='rgba(255, 215, 0, 0.3)'; this.style.transform='scale(1.1)'" onmouseout="this.style.background='rgba(255, 215, 0, 0.15)'; this.style.transform='scale(1)'">
          <svg width="10" height="10" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
           <path d="M11 5L6 9H2V15H6L11 19V5Z" fill="#ffd700" stroke="#ffd700" stroke-width="2" stroke-linejoin="round" /><path d="M15.54 8.46C16.4774 9.39764 17.0039 10.6692 17.0039 11.995C17.0039 13.3208 16.4774 14.5924 15.54 15.53" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /><path d="M19.07 4.93C20.9447 6.80528 21.9979 9.34836 21.9979 12C21.9979 14.6516 20.9447 17.1947 19.07 19.07" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          </svg></span>
        </div>
       </div>
      </div><!-- Learned Tab Content -->
      <div id="dict-tab-learned" class="dict-tab-content">
       <div class="word-entry">
        <div class="word-chinese">
         ‰Ω†Â•Ω
        </div>
        <div class="word-pinyin">
         n«ê h«éo
        </div>
        <div class="word-english">
         hello <span style="display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; background: rgba(255, 215, 0, 0.15); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 50%; cursor: pointer; margin-left: 8px; transition: all 0.3s ease; vertical-align: middle;" onmouseover="this.style.background='rgba(255, 215, 0, 0.3)'; this.style.transform='scale(1.1)'" onmouseout="this.style.background='rgba(255, 215, 0, 0.15)'; this.style.transform='scale(1)'">
          <svg width="10" height="10" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
           <path d="M11 5L6 9H2V15H6L11 19V5Z" fill="#ffd700" stroke="#ffd700" stroke-width="2" stroke-linejoin="round" /><path d="M15.54 8.46C16.4774 9.39764 17.0039 10.6692 17.0039 11.995C17.0039 13.3208 16.4774 14.5924 15.54 15.53" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /><path d="M19.07 4.93C20.9447 6.80528 21.9979 9.34836 21.9979 12C21.9979 14.6516 20.9447 17.1947 19.07 19.07" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          </svg></span>
        </div>
       </div>
       <div class="word-entry">
        <div class="word-chinese">
         Êàë
        </div>
        <div class="word-pinyin">
         w«í
        </div>
        <div class="word-english">
         I, me <span style="display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; background: rgba(255, 215, 0, 0.15); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 50%; cursor: pointer; margin-left: 8px; transition: all 0.3s ease; vertical-align: middle;" onmouseover="this.style.background='rgba(255, 215, 0, 0.3)'; this.style.transform='scale(1.1)'" onmouseout="this.style.background='rgba(255, 215, 0, 0.15)'; this.style.transform='scale(1)'">
          <svg width="10" height="10" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
           <path d="M11 5L6 9H2V15H6L11 19V5Z" fill="#ffd700" stroke="#ffd700" stroke-width="2" stroke-linejoin="round" /><path d="M15.54 8.46C16.4774 9.39764 17.0039 10.6692 17.0039 11.995C17.0039 13.3208 16.4774 14.5924 15.54 15.53" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /><path d="M19.07 4.93C20.9447 6.80528 21.9979 9.34836 21.9979 12C21.9979 14.6516 20.9447 17.1947 19.07 19.07" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          </svg></span>
        </div>
       </div>
       <div class="word-entry">
        <div class="word-chinese">
         Âè´
        </div>
        <div class="word-pinyin">
         ji√†o
        </div>
        <div class="word-english">
         to be called <span style="display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; background: rgba(255, 215, 0, 0.15); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 50%; cursor: pointer; margin-left: 8px; transition: all 0.3s ease; vertical-align: middle;" onmouseover="this.style.background='rgba(255, 215, 0, 0.3)'; this.style.transform='scale(1.1)'" onmouseout="this.style.background='rgba(255, 215, 0, 0.15)'; this.style.transform='scale(1)'">
          <svg width="10" height="10" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
           <path d="M11 5L6 9H2V15H6L11 19V5Z" fill="#ffd700" stroke="#ffd700" stroke-width="2" stroke-linejoin="round" /><path d="M15.54 8.46C16.4774 9.39764 17.0039 10.6692 17.0039 11.995C17.0039 13.3208 16.4774 14.5924 15.54 15.53" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /><path d="M19.07 4.93C20.9447 6.80528 21.9979 9.34836 21.9979 12C21.9979 14.6516 20.9447 17.1947 19.07 19.07" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          </svg></span>
        </div>
       </div>
       <div class="empty-state hidden">
        <div style="font-size: 64px; margin-bottom: 16px;">
         üìö
        </div>
        <h3 style="color: #2d3748; margin: 0 0 8px;">No words learned yet</h3>
        <p style="color: #718096; margin: 0;">Complete lessons to add words here!</p>
       </div>
      </div><!-- Saved Tab Content -->
      <div id="dict-tab-saved" class="dict-tab-content hidden">
       <div class="empty-state">
        <div style="font-size: 64px; margin-bottom: 16px;">
         üí¨
        </div>
        <h3 style="color: #2d3748; margin: 0 0 8px;">No saved dialogues</h3>
        <p style="color: #718096; margin: 0;">Save dialogues during lessons to review later!</p>
       </div>
      </div><!-- Slangs Tab Content -->
      <div id="dict-tab-slangs" class="dict-tab-content hidden">
       <div class="slang-entry">
        <div class="slang-header">
         <div class="word-chinese">
          Ë∂Ö
         </div>
         <div class="slang-badge">
          Common
         </div>
        </div>
        <div class="word-pinyin">
         chƒÅo
        </div>
        <div class="word-english">
         super, very (like "super cool")
        </div>
        <div class="slang-example">
         <div class="example-chinese">
          ÈÄôÂÄãË∂ÖÂ•ΩÂêÉÔºÅ
         </div>
         <div class="example-english">
          "This is super delicious!"
         </div>
        </div>
       </div>
       <div class="slang-entry">
        <div class="slang-header">
         <div class="word-chinese">
          Â∏•
         </div>
         <div class="slang-badge">
          Cool
         </div>
        </div>
        <div class="word-pinyin">
         shu√†i
        </div>
        <div class="word-english">
         handsome, cool, awesome
        </div>
        <div class="slang-example">
         <div class="example-chinese">
          ‰Ω†Â•ΩÂ∏•ÔºÅ
         </div>
         <div class="example-english">
          "You're so cool!"
         </div>
        </div>
       </div>
       <div class="slang-entry">
        <div class="slang-header">
         <div class="word-chinese">
          ËÆö
         </div>
         <div class="slang-badge">
          Popular
         </div>
        </div>
        <div class="word-pinyin">
         z√†n
        </div>
        <div class="word-english">
         awesome, "like" (social media)
        </div>
        <div class="slang-example">
         <div class="example-chinese">
          Ë∂ÖËÆöÁöÑÔºÅ
         </div>
         <div class="example-english">
          "That's awesome!"
         </div>
        </div>
       </div>
       <div class="slang-entry">
        <div class="slang-header">
         <div class="word-chinese">
          Âä†Ê≤π
         </div>
         <div class="slang-badge">
          Essential
         </div>
        </div>
        <div class="word-pinyin">
         jiƒÅ y√≥u
        </div>
        <div class="word-english">
         go for it, keep going (lit. "add oil")
        </div>
        <div class="slang-example">
         <div class="example-chinese">
          Âä†Ê≤πÔºå‰Ω†ÂèØ‰ª•ÁöÑÔºÅ
         </div>
         <div class="example-english">
          "Go for it! You can do it!"
         </div>
        </div>
       </div>
       <div class="slang-entry">
        <div class="slang-header">
         <div class="word-chinese">
          Ë†ª
         </div>
         <div class="slang-badge">
          Casual
         </div>
        </div>
        <div class="word-pinyin">
         m√°n
        </div>
        <div class="word-english">
         quite, pretty (Taiwanese usage)
        </div>
        <div class="slang-example">
         <div class="example-chinese">
          ÈÄôÂÄãË†ªÂ•ΩÂêÉÁöÑ„ÄÇ
         </div>
         <div class="example-english">
          "This is pretty tasty."
         </div>
        </div>
       </div>
       <div class="slang-entry">
        <div class="slang-header">
         <div class="word-chinese">
          Âé≤ÂÆ≥
         </div>
         <div class="slang-badge">
          Common
         </div>
        </div>
        <div class="word-pinyin">
         l√¨ h√†i
        </div>
        <div class="word-english">
         amazing, impressive, formidable
        </div>
        <div class="slang-example">
         <div class="example-chinese">
          ‰Ω†Â•ΩÂé≤ÂÆ≥ÔºÅ
         </div>
         <div class="example-english">
          "You're amazing!"
         </div>
        </div>
       </div>
       <div class="slang-entry">
        <div class="slang-header">
         <div class="word-chinese">
          Áàõ
         </div>
         <div class="slang-badge">
          Negative
         </div>
        </div>
        <div class="word-pinyin">
         l√†n
        </div>
        <div class="word-english">
         bad, terrible, broken
        </div>
        <div class="slang-example">
         <div class="example-chinese">
          ÈÄôÈÉ®ÈõªÂΩ±ÂæàÁàõ„ÄÇ
         </div>
         <div class="example-english">
          "This movie is terrible."
         </div>
        </div>
       </div>
       <div class="slang-entry">
        <div class="slang-header">
         <div class="word-chinese">
          ÊâØ
         </div>
         <div class="slang-badge">
          Trendy
         </div>
        </div>
        <div class="word-pinyin">
         chƒõ
        </div>
        <div class="word-english">
         ridiculous, absurd, crazy
        </div>
        <div class="slang-example">
         <div class="example-chinese">
          Â§™ÊâØ‰∫ÜÂêßÔºÅ
         </div>
         <div class="example-english">
          "That's so ridiculous!"
         </div>
        </div>
       </div>
      </div><!-- Meme Pronunciation Tab Content -->
      <div id="dict-tab-memes" class="dict-tab-content hidden">
       <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 16px; margin-bottom: 24px; text-align: center;">
        <h3 style="margin: 0 0 8px; font-size: 24px;">üòÇ Learn Chinese the Fun Way!</h3>
        <p style="margin: 0; opacity: 0.9;">English phrases that sound like Chinese</p>
       </div>

       <div class="meme-entry" style="background: white; border-radius: 20px; padding: 32px; margin-bottom: 24px; border-left: 6px solid #667eea; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.04); transition: all 0.3s ease; cursor: pointer;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(0, 0, 0, 0.12), 0 4px 8px rgba(0, 0, 0, 0.06)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 16px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.04)'">
        <div class="word-chinese" style="font-size: 24px; margin-bottom: 12px; font-weight: 600; color: #1a202c;">‰Ω†Â•ΩÂóé</div>
        <div class="meme-phonetic" style="font-size: 20px; color: #667eea; font-weight: 700; margin-bottom: 12px; font-style: italic; letter-spacing: 0.5px;">
         "Knee how ma?"
        </div>
        <div class="word-english" style="font-size: 16px; color: #4a5568; font-weight: 500;">How are you?</div>
       </div>

       <div class="meme-entry" style="background: white; border-radius: 20px; padding: 32px; margin-bottom: 24px; border-left: 6px solid #f093fb; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.04); transition: all 0.3s ease; cursor: pointer;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(0, 0, 0, 0.12), 0 4px 8px rgba(0, 0, 0, 0.06)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 16px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.04)'">
        <div class="word-chinese" style="font-size: 24px; margin-bottom: 12px; font-weight: 600; color: #1a202c;">‰Ω†‰ΩèÂú®Âì™Ë£°</div>
        <div class="meme-phonetic" style="font-size: 20px; color: #f093fb; font-weight: 700; margin-bottom: 12px; font-style: italic; letter-spacing: 0.5px;">
         "Knee jew's eye gnarly!"
        </div>
        <div class="word-english" style="font-size: 16px; color: #4a5568; font-weight: 500;">Where do you live?</div>
       </div>

       <div class="meme-entry" style="background: white; border-radius: 20px; padding: 32px; margin-bottom: 24px; border-left: 6px solid #4facfe; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.04); transition: all 0.3s ease; cursor: pointer;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(0, 0, 0, 0.12), 0 4px 8px rgba(0, 0, 0, 0.06)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 16px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.04)'">
        <div class="word-chinese" style="font-size: 24px; margin-bottom: 12px; font-weight: 600; color: #1a202c;">ÊàëÂÄë‰∏ÄËµ∑ÂéªÁúãÈõªÂΩ±</div>
        <div class="meme-phonetic" style="font-size: 20px; color: #4facfe; font-weight: 700; margin-bottom: 12px; font-style: italic; letter-spacing: 0.5px;">
         "Woa, man! Itchy chew, Ghandi Annie!"
        </div>
        <div class="word-english" style="font-size: 16px; color: #4a5568; font-weight: 500;">Let's go watch a movie</div>
       </div>

       <div class="meme-entry" style="background: white; border-radius: 20px; padding: 32px; margin-bottom: 24px; border-left: 6px solid #43e97b; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.04); transition: all 0.3s ease; cursor: pointer;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(0, 0, 0, 0.12), 0 4px 8px rgba(0, 0, 0, 0.06)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 16px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.04)'">
        <div class="word-chinese" style="font-size: 24px; margin-bottom: 12px; font-weight: 600; color: #1a202c;">Ë¨ùË¨ù‰Ω†</div>
        <div class="meme-phonetic" style="font-size: 20px; color: #43e97b; font-weight: 700; margin-bottom: 12px; font-style: italic; letter-spacing: 0.5px;">
         "Shay shay knee!"
        </div>
        <div class="word-english" style="font-size: 16px; color: #4a5568; font-weight: 500;">Thank you</div>
       </div>

       <div class="meme-entry" style="background: white; border-radius: 20px; padding: 32px; margin-bottom: 24px; border-left: 6px solid #fa709a; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.04); transition: all 0.3s ease; cursor: pointer;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(0, 0, 0, 0.12), 0 4px 8px rgba(0, 0, 0, 0.06)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 16px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.04)'">
        <div class="word-chinese" style="font-size: 24px; margin-bottom: 12px; font-weight: 600; color: #1a202c;">‰∏ÄÊùØÊãøÈêµ</div>
        <div class="meme-phonetic" style="font-size: 20px; color: #fa709a; font-weight: 700; margin-bottom: 12px; font-style: italic; letter-spacing: 0.5px;">
         "ebay knot yeah"
        </div>
        <div class="word-english" style="font-size: 16px; color: #4a5568; font-weight: 500;">One latte</div>
       </div>

       <div class="meme-entry" style="background: white; border-radius: 20px; padding: 32px; margin-bottom: 24px; border-left: 6px solid #ff9a56; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.04); transition: all 0.3s ease; cursor: pointer;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(0, 0, 0, 0.12), 0 4px 8px rgba(0, 0, 0, 0.06)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 16px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.04)'">
        <div class="word-chinese" style="font-size: 24px; margin-bottom: 12px; font-weight: 600; color: #1a202c;">ÊàëËÅΩ‰∏çÊáÇ</div>
        <div class="meme-phonetic" style="font-size: 20px; color: #ff9a56; font-weight: 700; margin-bottom: 12px; font-style: italic; letter-spacing: 0.5px;">
         "What timber dong"
        </div>
        <div class="word-english" style="font-size: 16px; color: #4a5568; font-weight: 500;">I don't understand</div>
       </div>

       <div class="meme-entry" style="background: white; border-radius: 20px; padding: 32px; margin-bottom: 24px; border-left: 6px solid #4facfe; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.04); transition: all 0.3s ease; cursor: pointer;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(0, 0, 0, 0.12), 0 4px 8px rgba(0, 0, 0, 0.06)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 16px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.04)'">
        <div class="word-chinese" style="font-size: 24px; margin-bottom: 12px; font-weight: 600; color: #1a202c;">ÊàëÊòéÁôΩ‰∫Ü</div>
        <div class="meme-phonetic" style="font-size: 20px; color: #4facfe; font-weight: 700; margin-bottom: 12px; font-style: italic; letter-spacing: 0.5px;">
         "Woman by law"
        </div>
        <div class="word-english" style="font-size: 16px; color: #4a5568; font-weight: 500;">I understand / I got it</div>
       </div>
      </div>
     </div>
    </div><!-- Explore Page -->
    <div id="explore-page" class="page-content hidden">
     <div class="explore-container">
      <h1 class="explore-title"><span id="explore-title-icon1"></span> Explore <span id="explore-title-icon2"></span></h1>

      <!-- Real-Time Practice -->
      <div class="explore-section">
       <h2 class="section-title">üí¨ Real-Time Practice</h2>
       <div class="horizontal-scroll">
        <div class="content-card">
         <div class="card-image" id="card-practice-1"></div>
         <div class="card-title">AI Chat</div>
        </div>
        <div class="content-card">
         <div class="card-image" id="card-practice-2"></div>
         <div class="card-title">Talk with Locals</div>
        </div>
       </div>
      </div>

      <!-- Tests -->
      <div class="explore-section">
       <h2 class="section-title">üìù Tests</h2>
       <div class="horizontal-scroll">
        <div class="content-card">
         <div class="card-image" id="card-test-1"></div>
         <div class="card-title">HSK 1</div>
        </div>
        <div class="content-card">
         <div class="card-image" id="card-test-2"></div>
         <div class="card-title">HSK 2</div>
        </div>
        <div class="content-card">
         <div class="card-image" id="card-test-3"></div>
         <div class="card-title">HSK 3</div>
        </div>
       </div>
      </div>

      <!-- Tips & Tricks -->
      <div class="explore-section">
       <h2 class="section-title">üí° Tips & Tricks</h2>
       <div class="horizontal-scroll">
        <div class="content-card">
         <div class="card-image" id="card-tips-1"></div>
         <div class="card-title">Study Tips</div>
        </div>
        <div class="content-card">
         <div class="card-image" id="card-tips-2"></div>
         <div class="card-title">Advice from Experts</div>
        </div>
        <div class="content-card">
         <div class="card-image" id="card-tips-3"></div>
         <div class="card-title">Success Stories</div>
        </div>
       </div>
      </div>

      <!-- Stories & Cultures -->
      <div class="explore-section">
       <h2 class="section-title">üèÆ Stories & Cultures</h2>
       <div class="horizontal-scroll">
        <div class="content-card">
         <div class="card-image" id="card-culture-1"></div>
         <div class="card-title">Taipei Tour</div>
        </div>
        <div class="content-card">
         <div class="card-image" id="card-culture-2"></div>
         <div class="card-title">Street Food Guide</div>
        </div>
        <div class="content-card">
         <div class="card-image" id="card-culture-3"></div>
         <div class="card-title">Kung Fu Basics</div>
        </div>
        <div class="content-card">
         <div class="card-image" id="card-culture-4"></div>
         <div class="card-title">News</div>
        </div>
        <div class="content-card" onclick="openDatingTips()" style="cursor: pointer;">
         <div class="card-image" id="card-culture-5"></div>
         <div class="card-title">Dating Tips</div>
        </div>
       </div>
      </div>

      <!-- Study Abroad & Partnerships -->
      <div class="explore-section">
       <h2 class="section-title">üéì Study Abroad & Partnerships</h2>
       <div class="horizontal-scroll">
        <div class="content-card">
         <div class="card-image" id="card-abroad-1"></div>
         <div class="card-title">Find Universities</div>
        </div>
        <div class="content-card">
         <div class="card-image" id="card-abroad-2"></div>
         <div class="card-title">Find Tuition Centers</div>
        </div>
        <div class="content-card">
         <div class="card-image" id="card-abroad-3"></div>
         <div class="card-title">Study Abroad</div>
        </div>
       </div>
      </div>

     </div>
    </div><!-- Home Page -->
    <div id="home-page" class="page-content hidden">
     <div class="player-room-container">
      <div class="room-scene">
       <div class="room-object avatar-display" onclick="openModal('character')">
        <div class="room-avatar" id="room-avatar"></div>
        <div class="object-label">
         Character
        </div>
       </div>
       <div class="room-object computer-object" onclick="openModal('progress')">
        <div class="object-icon" id="room-icon-computer"></div>
        <div class="object-label">
         Progress
        </div>
       </div>
       <div class="room-object wardrobe-object" onclick="openModal('wardrobe')">
        <div class="object-icon" id="room-icon-wardrobe"></div>
        <div class="object-label">
         Wardrobe
        </div>
       </div>
       <div class="room-object bookshelf-object" onclick="openModal('achievements')">
        <div class="object-icon" id="room-icon-bookshelf"></div>
        <div class="object-label">
         Achievements
        </div>
       </div>
       <div class="room-object door-object" onclick="openModal('settings')">
        <div class="object-icon" id="room-icon-door"></div>
        <div class="object-label">
         Settings
        </div>
       </div>
       <div class="room-currency"><span class="currency-icon" id="room-icon-currency"></span> <span class="currency-amount" id="room-yuan-bao">100</span>
       </div>
      </div>
     </div>
    </div>
   </div>
   <nav class="bottom-nav"><button class="nav-item active" id="nav-learn" onclick="switchTab('learn-select')"> <span class="nav-icon" id="nav-icon-learn"></span> <span class="nav-label">Learn</span> </button> <button class="nav-item" id="nav-home" onclick="switchTab('home')"> <span class="nav-icon" id="nav-icon-home"></span> <span class="nav-label">Room</span> </button> <button class="nav-item" id="nav-world" onclick="switchTab('world')"> <span class="nav-icon" id="nav-icon-world"></span> <span class="nav-label">World</span> </button> <button class="nav-item" id="nav-dictionary" onclick="switchTab('dictionary')"> <span class="nav-icon" id="nav-icon-dictionary"></span> <span class="nav-label">Dictionary</span> </button> <button class="nav-item" id="nav-explore" onclick="switchTab('explore')"> <span class="nav-icon" id="nav-icon-explore"></span> <span class="nav-label">Explore</span> </button>
   </nav>
  </div><!-- Modals -->
  <div id="modal-overlay" class="modal-overlay hidden" onclick="closeModal()">
   <div class="modal-content" onclick="event.stopPropagation()"><button class="modal-close" onclick="closeModal()">√ó</button>
    <div id="modal-body"></div>
   </div>
  </div>
  <!-- Shopping Game Modal -->
  <div id="shopping-game-modal" class="modal-overlay hidden" style="z-index: 10000;">
   <div class="shopping-game-container" onclick="event.stopPropagation()" style="background: white; border-radius: 24px; padding: 32px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; position: relative;">
    <button onclick="closeShoppingGame()" style="position: absolute; top: 16px; right: 16px; background: #ff4444; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 24px; cursor: pointer; font-weight: bold;">√ó</button>
    <h2 style="text-align: center; color: #2d3748; margin-bottom: 8px;">üõí Shopping Challenge</h2>
    <p style="text-align: center; color: #718096; margin-bottom: 24px;">Click the items on your shopping list!</p>

    <div style="background: #f7fafc; padding: 16px; border-radius: 12px; margin-bottom: 24px; border: 2px solid #e2e8f0;">
     <h3 style="margin: 0 0 12px 0; color: #2d3748;">üìù Shopping List:</h3>
     <div id="shopping-list" style="display: flex; flex-direction: column; gap: 8px;"></div>
    </div>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
     <div style="font-size: 20px; font-weight: 700; color: #2d3748;">‚è±Ô∏è Time: <span id="game-timer" style="color: #ff0000;">30</span>s</div>
     <div style="font-size: 20px; font-weight: 700; color: #2d3748;">‚≠ê Score: <span id="game-score">0</span></div>
    </div>

    <div id="items-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px;"></div>

    <button id="submit-btn" onclick="checkShoppingAnswers()" style="width: 100%; padding: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: 700; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">Check Answers</button>

    <div id="game-result" style="margin-top: 20px; padding: 16px; border-radius: 12px; display: none; text-align: center; font-size: 18px; font-weight: 700;"></div>
   </div>
  </div>
  <!-- Restaurant Ordering Game Modal -->
  <div id="restaurant-game-modal" class="modal-overlay hidden" style="z-index: 10000;">
   <div class="restaurant-game-container" onclick="event.stopPropagation()" style="background: white; border-radius: 24px; padding: 32px; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto; position: relative;">
    <button onclick="closeRestaurantGame()" style="position: absolute; top: 16px; right: 16px; background: #ff4444; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 24px; cursor: pointer; font-weight: bold;">√ó</button>
    <h2 style="text-align: center; color: #2d3748; margin-bottom: 8px;">üçΩÔ∏è Restaurant Ordering</h2>
    <p style="text-align: center; color: #718096; margin-bottom: 24px;">Build the correct sentence to order the dish!</p>

    <div style="background: #f7fafc; padding: 24px; border-radius: 12px; margin-bottom: 24px; border: 2px solid #e2e8f0; text-align: center;">
     <h3 style="margin: 0 0 16px 0; color: #2d3748;">Order this dish:</h3>
     <div id="current-dish" style="font-size: 48px; margin-bottom: 8px;"></div>
     <div id="dish-name" style="font-size: 24px; font-weight: 700; color: #2d3748;"></div>
    </div>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
     <div style="font-size: 20px; font-weight: 700; color: #2d3748;">‚è±Ô∏è Time: <span id="restaurant-timer" style="color: #ff0000;">30</span>s</div>
     <div style="font-size: 20px; font-weight: 700; color: #2d3748;">‚≠ê Score: <span id="restaurant-score">0</span></div>
    </div>

    <div style="background: #fff; padding: 16px; border-radius: 12px; margin-bottom: 16px; border: 2px solid #e2e8f0; min-height: 60px;">
     <h4 style="margin: 0 0 12px 0; color: #718096; font-size: 14px;">Your sentence:</h4>
     <div id="sentence-builder" style="display: flex; flex-wrap: wrap; gap: 8px; min-height: 40px;"></div>
    </div>

    <div style="margin-bottom: 24px;">
     <h4 style="margin: 0 0 12px 0; color: #718096; font-size: 14px;">Available words:</h4>
     <div id="word-tiles" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
    </div>

    <div style="display: flex; gap: 12px;">
     <button onclick="clearSentence()" style="flex: 1; padding: 14px; background: #e2e8f0; color: #2d3748; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer;">Clear</button>
     <button id="restaurant-submit-btn" onclick="checkRestaurantAnswer()" style="flex: 2; padding: 14px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">Submit Order</button>
    </div>

    <div id="restaurant-result" style="margin-top: 20px; padding: 16px; border-radius: 12px; display: none; text-align: center; font-size: 18px; font-weight: 700;"></div>
   </div>
  </div>
  <!-- Park Flashcard Game Modal -->
  <div id="park-game-modal" class="modal-overlay hidden" style="z-index: 10000;">
   <div class="park-game-container" onclick="event.stopPropagation()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 24px; padding: 32px; max-width: 500px; width: 90%; max-height: 80vh; overflow: visible; position: relative;">
    <button onclick="closeParkGame()" style="position: absolute; top: 16px; right: 16px; background: #ff4444; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 24px; cursor: pointer; font-weight: bold; z-index: 10;">√ó</button>
    <h2 style="text-align: center; color: white; margin-bottom: 8px;">üå≥ Flashcard Challenge</h2>
    <p style="text-align: center; color: rgba(255,255,255,0.9); margin-bottom: 8px;">Swipe right ‚úì if correct, left ‚úó if wrong!</p>
    <p style="text-align: center; color: rgba(255,255,255,0.8); margin-bottom: 24px; font-size: 14px;">‚úì +50  |  ‚úó -25</p>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
     <div style="font-size: 20px; font-weight: 700; color: white;">‚è±Ô∏è <span id="park-timer" style="color: #ffd700;">15</span>s</div>
     <div style="font-size: 20px; font-weight: 700; color: white;">‚≠ê <span id="park-score" style="color: #ffd700;">0</span></div>
    </div>

    <!-- Flashcard -->
    <div id="flashcard" style="background: white; border-radius: 20px; padding: 48px 32px; margin-bottom: 24px; text-align: center; min-height: 300px; display: flex; flex-direction: column; justify-content: center; align-items: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); transition: transform 0.3s ease, opacity 0.3s ease;">
     <div id="card-emoji" style="font-size: 120px; margin-bottom: 24px;"></div>
     <div id="card-chinese" style="font-size: 36px; font-weight: 700; color: #2d3748; margin-bottom: 8px;"></div>
     <div id="card-pinyin" style="font-size: 18px; color: #718096;"></div>
    </div>

    <!-- Swipe Buttons -->
    <div style="display: flex; gap: 24px; justify-content: center; margin-bottom: 20px;">
     <button id="swipe-left-btn" onclick="swipeLeft()" style="width: 80px; height: 80px; background: #ff4444; color: white; border: none; border-radius: 50%; font-size: 40px; cursor: pointer; box-shadow: 0 8px 20px rgba(255,68,68,0.4); transition: all 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">‚úó</button>
     <button id="swipe-right-btn" onclick="swipeRight()" style="width: 80px; height: 80px; background: #48bb78; color: white; border: none; border-radius: 50%; font-size: 40px; cursor: pointer; box-shadow: 0 8px 20px rgba(72,187,120,0.4); transition: all 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">‚úì</button>
    </div>

    <div id="park-result-backdrop" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); display: none; z-index: 9; border-radius: 24px;"></div>
    <div id="park-result" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; max-width: 400px; padding: 24px; border-radius: 16px; display: none; text-align: center; font-size: 18px; font-weight: 700; background: white; box-shadow: 0 20px 60px rgba(0,0,0,0.4); z-index: 10;"></div>
   </div>
  </div>
  <!-- Leaderboard Modal -->
  <div id="leaderboard-modal" class="modal-overlay hidden" style="z-index: 10001;">
   <div class="leaderboard-container" onclick="event.stopPropagation()" style="background: white; border-radius: 24px; padding: 32px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; position: relative;">
    <button onclick="closeLeaderboard()" style="position: absolute; top: 16px; right: 16px; background: #ff4444; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 24px; cursor: pointer; font-weight: bold;">√ó</button>
    <h2 style="text-align: center; color: #2d3748; margin-bottom: 8px;">üèÜ Leaderboard</h2>
    <p style="text-align: center; color: #718096; margin-bottom: 24px;">Top Flashcard Masters</p>

    <div id="leaderboard-content" style="padding: 20px;">
     <!-- Leaderboard content will go here -->
     <p style="text-align: center; color: #718096; font-size: 16px;">Leaderboard coming soon...</p>
    </div>
   </div>
  </div>
  <!-- Dating Tips Modal -->
  <div id="dating-tips-modal" class="modal-overlay hidden" style="z-index: 10001;" onclick="closeDatingTips()">
   <div class="dating-tips-container" onclick="event.stopPropagation()" style="background: white; border-radius: 24px; padding: 32px; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto; position: relative;">
    <button onclick="closeDatingTips()" style="position: absolute; top: 16px; right: 16px; background: #ff4444; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 24px; cursor: pointer; font-weight: bold;">√ó</button>
    <h2 style="text-align: center; color: #2d3748; margin-bottom: 8px;">üíï Dating Tips</h2>
    <p style="text-align: center; color: #718096; margin-bottom: 24px;">Master the art of romance in Chinese-speaking regions</p>

    <div style="display: grid; gap: 24px;">
     <!-- General Dating Phrases -->
     <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); border-radius: 16px; padding: 24px;">
      <h3 style="margin: 0 0 16px; font-size: 20px; font-weight: 700; color: #1a202c;">üí¨ What to Say</h3>
      <div style="background: rgba(255,255,255,0.9); border-radius: 12px; padding: 16px; margin-bottom: 12px;">
       <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #1a202c;">‰Ω†ÊúâÁ©∫ÁöÑË©±ÔºåÊàëÂÄë‰∏ÄËµ∑ÂéªÂñùÊùØÂíñÂï°ÂêßÔºü</div>
       <div style="font-size: 14px; margin-bottom: 4px; color: #2d3748;">N«ê y«íu k√≤ng de hu√†, w«ímen y√¨q«ê q√π hƒì bƒìi kƒÅfƒìi ba?</div>
       <div style="font-size: 14px; color: #4a5568; font-style: italic;">If you're free, let's go get coffee together?</div>
      </div>
      <div style="background: rgba(255,255,255,0.9); border-radius: 12px; padding: 16px; margin-bottom: 12px;">
       <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #1a202c;">‰Ω†ÁúüÁöÑÂæàÊúâÊÑèÊÄù„ÄÇ</div>
       <div style="font-size: 14px; margin-bottom: 4px; color: #2d3748;">N«ê zhƒìn de hƒõn y«íu y√¨si.</div>
       <div style="font-size: 14px; color: #4a5568; font-style: italic;">You're really interesting.</div>
      </div>
      <div style="background: rgba(255,255,255,0.9); border-radius: 12px; padding: 16px; margin-bottom: 12px;">
       <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #1a202c;">ÊàëÂæàÊÉ≥ÂÜçË¶ãÂà∞‰Ω†„ÄÇ</div>
       <div style="font-size: 14px; margin-bottom: 4px; color: #2d3748;">W«í hƒõn xi«éng z√†i ji√†n d√†o n«ê.</div>
       <div style="font-size: 14px; color: #4a5568; font-style: italic;">I'd really like to see you again.</div>
      </div>
      <div style="background: rgba(255,255,255,0.9); border-radius: 12px; padding: 16px;">
       <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #1a202c;">ÊàëÂñúÊ≠°‰Ω†„ÄÇ</div>
       <div style="font-size: 14px; margin-bottom: 4px; color: #2d3748;">W«í x«êhuƒÅn n«ê.</div>
       <div style="font-size: 14px; color: #4a5568; font-style: italic;">I like you.</div>
      </div>
     </div>

     <!-- Taiwan Section -->
     <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-radius: 16px; padding: 24px;">
      <h3 style="margin: 0 0 16px; font-size: 20px; font-weight: 700; color: #1a202c;">üáπüáº In Taiwan (Line)</h3>
      <div style="background: rgba(255,255,255,0.9); border-radius: 12px; padding: 16px; margin-bottom: 12px;">
       <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #1a202c;">ÊàëÂèØ‰ª•Âä†‰Ω†ÁöÑ Line ÂóéÔºü</div>
       <div style="font-size: 14px; margin-bottom: 4px; color: #2d3748;">W«í kƒõy«ê jiƒÅ n«ê de Line ma?</div>
       <div style="font-size: 14px; color: #4a5568; font-style: italic;">Can I add you on Line?</div>
      </div>
      <div style="background: rgba(255,255,255,0.9); border-radius: 12px; padding: 16px; margin-bottom: 12px;">
       <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #1a202c;">ÂèØ‰ª•Áµ¶Êàë‰Ω†ÁöÑ Line ID ÂóéÔºü</div>
       <div style="font-size: 14px; margin-bottom: 4px; color: #2d3748;">Kƒõy«ê gƒõi w«í n«ê de Line ID ma?</div>
       <div style="font-size: 14px; color: #4a5568; font-style: italic;">Can you give me your Line ID?</div>
      </div>
      <div style="background: rgba(255,255,255,0.9); border-radius: 12px; padding: 16px;">
       <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #1a202c;">ÊàëÂÄë‰øùÊåÅËÅØÁµ°ÂêßÔºÅ</div>
       <div style="font-size: 14px; margin-bottom: 4px; color: #2d3748;">W«ímen b«éoch√≠ li√°nlu√≤ ba!</div>
       <div style="font-size: 14px; color: #4a5568; font-style: italic;">Let's keep in touch!</div>
      </div>
     </div>

     <!-- China Section -->
     <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 16px; padding: 24px;">
      <h3 style="margin: 0 0 16px; font-size: 20px; font-weight: 700; color: #1a202c;">üá®üá≥ In China (WeChat)</h3>
      <div style="background: rgba(255,255,255,0.9); border-radius: 12px; padding: 16px; margin-bottom: 12px;">
       <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #1a202c;">Âä†ÂÄãÂæÆ‰ø°ÂêßÔºü</div>
       <div style="font-size: 14px; margin-bottom: 4px; color: #2d3748;">JiƒÅ ge wƒìix√¨n ba?</div>
       <div style="font-size: 14px; color: #4a5568; font-style: italic;">Add me on WeChat?</div>
      </div>
      <div style="background: rgba(255,255,255,0.9); border-radius: 12px; padding: 16px; margin-bottom: 12px;">
       <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #1a202c;">ÂèØ‰ª•ÊéÉ‰∏Ä‰∏ã‰Ω†ÁöÑÂæÆ‰ø°ÂóéÔºü</div>
       <div style="font-size: 14px; margin-bottom: 4px; color: #2d3748;">Kƒõy«ê s«éo y√≠xi√† n«ê de wƒìix√¨n ma?</div>
       <div style="font-size: 14px; color: #4a5568; font-style: italic;">Can I scan your WeChat QR code?</div>
      </div>
      <div style="background: rgba(255,255,255,0.9); border-radius: 12px; padding: 16px;">
       <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #1a202c;">Êñπ‰æøÂä†ÂÄãÂ•ΩÂèãÂóéÔºü</div>
       <div style="font-size: 14px; margin-bottom: 4px; color: #2d3748;">FƒÅngbi√†n jiƒÅ ge h«éoy«íu ma?</div>
       <div style="font-size: 14px; color: #4a5568; font-style: italic;">Is it okay to add you as a friend?</div>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
    // ========================================
    // CENTRALIZED ICON SYSTEM
    // All emojis stored in one place
    // ========================================
    
    const ICONS = {
      // Login screen
      login: {
        lantern: '\uD83C\uDFEE', // üèÆ
      },
      
      // Characters
      characters: {
        david: '\uD83D\uDC68', // üë®
        phin: '\uD83D\uDC69'     // üë©
      },
      
      // Lessons
      lessons: {
        greetings: '\uD83D\uDC4B',  // üëã waving hand
        numbers: '\uD83C\uDF5C',     // üçú noodles
        food: '\uD83C\uDF89',        // üéâ party popper
        shopping: '\uD83D\uDED2',    // üõí shopping cart
        directions: '\uD83E\uDDED'   // üß≠ compass
      },
      
      // World
      world: {
        market: '\uD83C\uDFEA',      // üè™ convenience store
        restaurant: '\uD83C\uDF7D',  // üçΩÔ∏è fork and knife with plate
        park: '\uD83C\uDF32',        // üå≤ evergreen tree
        npcs: [
          '\uD83D\uDC68',  // üë®
          '\uD83D\uDC69',  // üë©
          '\uD83D\uDC74',  // üë¥
          '\uD83D\uDC67'   // üëß
        ]
      },
      
      // Room
      room: {
        computer: '\uD83D\uDCBB',  // üíª
        wardrobe: '\uD83D\uDC54',  // üëî
        bookshelf: '\uD83D\uDCDA', // üìö
        door: '\uD83D\uDEAA',      // üö™
        currency: '\uD83D\uDCB0'   // üí∞
      },
      
      // Navigation
      nav: {
        learn: '\uD83D\uDCDA',     // üìö
        home: '\uD83C\uDFE0',      // üè†
        world: '\uD83C\uDF0F',     // üåè
        dictionary: '\uD83D\uDCD6', // üìñ
        explore: '\uD83D\uDD0D'    // üîç
      },
      
      // UI
      ui: {
        checkmark: '\u2713',       // ‚úì checkmark
        coin: '\uD83D\uDCB0',      // üí∞ money bag
        fire: '\uD83D\uDD25',      // üî• fire
        star: '\uD83C\uDF1F',      // ‚≠ê star
        trophy: '\uD83C\uDFC6',    // üèÜ trophy
        gear: '\u2699\uFE0F',      // ‚öôÔ∏è gear
        party: '\uD83C\uDF89',     // üéâ party popper
        arrow: '\u2192'            // ‚Üí arrow
      },
      
      // Wardrobe
      wardrobe: {
        outfits: {
          student: '\uD83C\uDF93',  // üéì
          casual: '\uD83D\uDC55',   // üëï
          formal: '\uD83D\uDC54',   // üëî
          sporty: '\u26BD'          // ‚öΩ
        },
        accessories: {
          none: '\u274C',            // ‚ùå cross mark
          glasses: '\uD83D\uDC53',   // üëì glasses
          headband: '\uD83C\uDF80',  // üéÄ ribbon
          earrings: '\uD83D\uDC8E',  // üíé gem stone
          necklace: '\uD83D\uDCFF',  // üìø prayer beads
          scarf: '\uD83E\uDDE3'      // üß£ scarf
        }
      },
      
      // Explore content
      content: {
        // Real-Time Practice
        aiChat: '\uD83E\uDD16',        // ü§ñ robot
        locals: '\uD83D\uDDE3\uFE0F',  // üó£Ô∏è speaking head

        // Tests
        hsk1: '\u270F\uFE0F',          // ‚úèÔ∏è pencil
        hsk2: '\uD83D\uDCDD',          // üìù memo
        hsk3: '\uD83D\uDCCB',          // üìã clipboard

        // Tips & Tricks
        studyTips: '\uD83D\uDCA1',     // üí° light bulb
        experts: '\uD83D\uDC68\u200D\uD83C\uDFEB', // üë®‚Äçüè´ teacher
        stories: '\u2B50',             // ‚≠ê star

        // Stories & Cultures
        taipei: '\uD83C\uDFD9\uFE0F',  // üèôÔ∏è city
        food: '\uD83C\uDF5C',          // üçú noodles
        kungfu: '\uD83E\uDD4B',        // ü•ã martial arts uniform
        news: '\uD83D\uDCF0',          // üì∞ newspaper
        dating: '\uD83D\uDC95',        // üíï two hearts

        // Study Abroad
        university: '\uD83C\uDFEB',    // üè´ school
        tuition: '\uD83D\uDCDA',       // üìö books
        abroad: '\u2708\uFE0F'         // ‚úàÔ∏è airplane
      }
    };
    
    // ========================================
    // ICON UTILITIES
    // ========================================
    
    // Set icon by element ID and icon path
    function setIcon(elementId, iconPath) {
      const element = document.getElementById(elementId);
      if (element) {
        const icon = getIcon(iconPath);
        if (icon) {
          element.textContent = icon;
        }
      }
    }
    
    // Get icon from path (dot notation)
    function getIcon(path) {
      return path.split('.').reduce((obj, key) => obj?.[key], ICONS);
    }
    
    // Set multiple icons at once
    function setIcons(iconMap) {
      Object.entries(iconMap).forEach(([elementId, iconPath]) => {
        setIcon(elementId, iconPath);
      });
    }
    
    // ========================================
    // INITIALIZE ALL ICONS
    // ========================================
    
    function initializeAllIcons() {
      // Login screen
      setIcon('login-icon-1', 'login.lantern');
      setIcon('login-icon-2', 'login.lantern');
      
      // Back button
      setIcon('back-arrow', 'ui.arrow');
      setIcon('arrow-icon', 'ui.arrow');
      
      // Lesson map
      setIcon('lesson-icon-greetings', 'lessons.greetings');
      setIcon('lesson-icon-numbers', 'lessons.numbers');
      setIcon('lesson-icon-food', 'lessons.food');
      setIcon('lesson-icon-shopping', 'lessons.shopping');
      setIcon('lesson-icon-directions', 'lessons.directions');
      
      // Characters
      updateDavidAvatar();
      updateConversationAvatar();
      
      // World
      setIcon('world-stage-market', 'world.market');
      setIcon('world-stage-restaurant', 'world.restaurant');
      setIcon('world-stage-park', 'world.park');
      setIcon('npc1', 'world.npcs.0');
      setIcon('npc2', 'world.npcs.1');
      setIcon('npc3', 'world.npcs.2');
      setIcon('npc4', 'world.npcs.3');
      
      // Room
      setIcon('room-icon-computer', 'room.computer');
      setIcon('room-icon-wardrobe', 'room.wardrobe');
      setIcon('room-icon-bookshelf', 'room.bookshelf');
      setIcon('room-icon-door', 'room.door');
      setIcon('room-icon-currency', 'room.currency');
      setIcon('world-icon-currency', 'room.currency');
      
      // Navigation
      setIcon('nav-icon-learn', 'nav.learn');
      setIcon('nav-icon-home', 'nav.home');
      setIcon('nav-icon-world', 'nav.world');
      setIcon('nav-icon-dictionary', 'nav.dictionary');
      setIcon('nav-icon-explore', 'nav.explore');
      
      // Dictionary
      setIcon('dict-icon', 'nav.dictionary');
      
      // Explore page
      setIcon('explore-title-icon1', 'ui.star');
      setIcon('explore-title-icon2', 'ui.star');

      // Real-Time Practice
      setIcon('card-practice-1', 'content.aiChat');
      setIcon('card-practice-2', 'content.locals');

      // Tests
      setIcon('card-test-1', 'content.hsk1');
      setIcon('card-test-2', 'content.hsk2');
      setIcon('card-test-3', 'content.hsk3');

      // Tips & Tricks
      setIcon('card-tips-1', 'content.studyTips');
      setIcon('card-tips-2', 'content.experts');
      setIcon('card-tips-3', 'content.stories');

      // Stories & Cultures
      setIcon('card-culture-1', 'content.taipei');
      setIcon('card-culture-2', 'content.food');
      setIcon('card-culture-3', 'content.kungfu');
      setIcon('card-culture-4', 'content.news');
      setIcon('card-culture-5', 'content.dating');

      // Study Abroad & Partnerships
      setIcon('card-abroad-1', 'content.university');
      setIcon('card-abroad-2', 'content.tuition');
      setIcon('card-abroad-3', 'content.abroad');
    }
    
    // ========================================
    // RPG CHARACTER RENDERING
    // ========================================
    
    function createRPGCharacter(skinTone, outfit, hair, accessory) {
      // Character proportions and colors
      const bodyColors = {
        'light': '#ffd1b3',
        'medium': '#d4a373',
        'tan': '#b08968',
        'dark': '#8b6f47'
      };
      
      const outfitColors = {
        'student': { primary: '#ff6b9d', secondary: '#4a90e2', accent: '#ffc0e0' },
        'casual': { primary: '#ffb6c1', secondary: '#4a90e2', accent: '#ff69b4' },
        'formal': { primary: '#ffffff', secondary: '#2c3e50', accent: '#3498db', collar: '#e8f4f8' },
        'sporty': { primary: '#ff69b4', secondary: '#4a90e2', accent: '#ff1493' }
      };
      
      const hairColors = {
        'black': '#2c2c2c',
        'brown': '#8b6f47',
        'blonde': '#f4d03f',
        'red': '#d63447',
        'blue': '#5dade2',
        'pink': '#ff87c3'
      };
      
      const skinColor = bodyColors[skinTone] || bodyColors.light;
      const outfitColor = outfitColors[outfit] || outfitColors.student;
      const hairColor = hairColors[hair] || hairColors.black;
      
      return `
        <svg viewBox="0 0 180 280" xmlns="http://www.w3.org/2000/svg" style="width: 100%; height: 100%;">
          <!-- Shadow -->
          <ellipse cx="90" cy="275" rx="50" ry="8" fill="rgba(0,0,0,0.2)"/>
          
          <!-- HAIR BACK LAYER -->
          <ellipse cx="90" cy="75" rx="42" ry="48" fill="${hairColor}"/>
          <path d="M 50 50 Q 45 70, 40 95 Q 52 80, 55 50 Z" fill="${hairColor}"/>
          <path d="M 130 50 Q 135 70, 140 95 Q 128 80, 125 50 Z" fill="${hairColor}"/>
          
          <!-- Legs -->
          <rect x="68" y="160" width="18" height="110" fill="${outfitColor.secondary}" rx="9"/>
          <rect x="94" y="160" width="18" height="110" fill="${outfitColor.secondary}" rx="9"/>
          <line x1="77" y1="165" x2="77" y2="270" stroke="rgba(0,0,0,0.2)" stroke-width="1"/>
          <line x1="103" y1="165" x2="103" y2="270" stroke="rgba(0,0,0,0.2)" stroke-width="1"/>
          <rect x="70" y="160" width="4" height="6" fill="rgba(0,0,0,0.3)" rx="1"/>
          <rect x="96" y="160" width="4" height="6" fill="rgba(0,0,0,0.3)" rx="1"/>
          
          <!-- Shoes -->
          <ellipse cx="77" cy="270" rx="14" ry="7" fill="#333333"/>
          <ellipse cx="103" cy="270" rx="14" ry="7" fill="#333333"/>
          <ellipse cx="77" cy="268" rx="10" ry="5" fill="#555555"/>
          <ellipse cx="103" cy="268" rx="10" ry="5" fill="#555555"/>
          
          <!-- Body -->
          ${outfit === 'formal' ? `
            <rect x="60" y="100" width="60" height="75" fill="${outfitColor.primary}" rx="2"/>
            <rect x="88" y="100" width="4" height="75" fill="${outfitColor.collar}" opacity="0.8"/>
            <circle cx="90" cy="110" r="2" fill="${outfitColor.accent}"/>
            <circle cx="90" cy="125" r="2" fill="${outfitColor.accent}"/>
            <circle cx="90" cy="140" r="2" fill="${outfitColor.accent}"/>
            <circle cx="90" cy="155" r="2" fill="${outfitColor.accent}"/>
            <circle cx="90" cy="170" r="2" fill="${outfitColor.accent}"/>
            <path d="M 78 100 L 72 108 L 82 108 Z" fill="${outfitColor.primary}" stroke="${outfitColor.collar}" stroke-width="1"/>
            <path d="M 102 100 L 108 108 L 98 108 Z" fill="${outfitColor.primary}" stroke="${outfitColor.collar}" stroke-width="1"/>
            <line x1="72" y1="104" x2="82" y2="108" stroke="rgba(0,0,0,0.1)" stroke-width="0.5"/>
            <line x1="108" y1="104" x2="98" y2="108" stroke="rgba(0,0,0,0.1)" stroke-width="0.5"/>
            <ellipse cx="90" cy="175" rx="30" ry="3" fill="rgba(0,0,0,0.08)"/>
            <path d="M 78 100 Q 90 105, 102 100" fill="${skinColor}"/>
            <rect x="48" y="105" width="14" height="70" fill="${outfitColor.primary}" rx="7"/>
            <rect x="48" y="168" width="14" height="10" fill="${outfitColor.collar}" rx="2"/>
            <circle cx="55" cy="173" r="1.5" fill="${outfitColor.accent}"/>
            <rect x="118" y="105" width="14" height="70" fill="${outfitColor.primary}" rx="7"/>
            <rect x="118" y="168" width="14" height="10" fill="${outfitColor.collar}" rx="2"/>
            <circle cx="125" cy="173" r="1.5" fill="${outfitColor.accent}"/>
          ` : `
            <rect x="60" y="100" width="60" height="75" fill="${outfitColor.primary}" rx="3"/>
            <ellipse cx="90" cy="175" rx="30" ry="4" fill="rgba(0,0,0,0.1)"/>
            <ellipse cx="90" cy="100" rx="15" ry="6" fill="${skinColor}"/>
            <rect x="52" y="105" width="12" height="22" fill="${outfitColor.primary}" rx="6"/>
            <ellipse cx="58" cy="127" rx="6" ry="4" fill="${outfitColor.primary}"/>
            <rect x="116" y="105" width="12" height="22" fill="${outfitColor.primary}" rx="6"/>
            <ellipse cx="122" cy="127" rx="6" ry="4" fill="${outfitColor.primary}"/>
          `}
          
          <!-- Arms -->
          <rect x="47" y="120" width="10" height="55" fill="${skinColor}" rx="5"/>
          <rect x="123" y="120" width="10" height="55" fill="${skinColor}" rx="5"/>
          
          <!-- Hands -->
          <circle cx="46" cy="180" r="8" fill="${skinColor}"/>
          <circle cx="134" cy="180" r="8" fill="${skinColor}"/>
          
          <!-- Neck -->
          <rect x="82" y="95" width="16" height="18" fill="${skinColor}" rx="8"/>
          
          <!-- Head -->
          <ellipse cx="90" cy="70" rx="30" ry="32" fill="${skinColor}"/>
          
          <!-- Eyes -->
          <ellipse cx="75" cy="68" rx="6" ry="7" fill="white"/>
          <ellipse cx="105" cy="68" rx="6" ry="7" fill="white"/>
          <circle cx="76" cy="69" r="4.5" fill="#4a3728"/>
          <circle cx="106" cy="69" r="4.5" fill="#4a3728"/>
          <circle cx="77" cy="67" r="2" fill="white"/>
          <circle cx="107" cy="67" r="2" fill="white"/>
          
          <!-- Eyelashes -->
          <path d="M 69 63 Q 67 61, 66 62" stroke="#2c2c2c" stroke-width="1.5" fill="none" stroke-linecap="round"/>
          <path d="M 75 62 Q 75 59, 74 59" stroke="#2c2c2c" stroke-width="1.5" fill="none" stroke-linecap="round"/>
          <path d="M 81 63 Q 83 61, 84 62" stroke="#2c2c2c" stroke-width="1.5" fill="none" stroke-linecap="round"/>
          <path d="M 99 63 Q 97 61, 96 62" stroke="#2c2c2c" stroke-width="1.5" fill="none" stroke-linecap="round"/>
          <path d="M 105 62 Q 105 59, 106 59" stroke="#2c2c2c" stroke-width="1.5" fill="none" stroke-linecap="round"/>
          <path d="M 111 63 Q 113 61, 114 62" stroke="#2c2c2c" stroke-width="1.5" fill="none" stroke-linecap="round"/>
          
          <!-- Eyebrows -->
          <path d="M 68 61 Q 75 59, 82 60" stroke="#2c2c2c" stroke-width="1.2" fill="none" stroke-linecap="round"/>
          <path d="M 98 60 Q 105 59, 112 61" stroke="#2c2c2c" stroke-width="1.2" fill="none" stroke-linecap="round"/>
          
          <!-- Nose -->
          <path d="M 90 74 L 90 80" stroke="${skinColor}" stroke-width="1.5" fill="none" stroke-linecap="round" opacity="0.3"/>
          <ellipse cx="88" cy="81" rx="2" ry="1.5" fill="${skinColor}" opacity="0.4"/>
          <ellipse cx="92" cy="81" rx="2" ry="1.5" fill="${skinColor}" opacity="0.4"/>
          
          <!-- Smile -->
          <path d="M 75 86 Q 90 92, 105 86" stroke="#ff9999" stroke-width="2" fill="none" stroke-linecap="round"/>
          <path d="M 75 86 Q 90 89, 105 86" fill="#ffcccc" opacity="0.3"/>
          
          <!-- Blush -->
          <ellipse cx="63" cy="76" rx="9" ry="6" fill="#ffb3ba" opacity="0.4"/>
          <ellipse cx="117" cy="76" rx="9" ry="6" fill="#ffb3ba" opacity="0.4"/>
          
          <!-- HAIR FRONT LAYER -->
          <path d="M 57 42 Q 73 30, 90 28 Q 107 30, 123 42 Q 115 48, 90 45 Q 65 48, 57 42 Z" fill="${hairColor}"/>
          <path d="M 90 28 L 87 38 L 90 45 L 93 38 Z" fill="rgba(0,0,0,0.15)"/>
          
          <!-- Accessory -->
          ${accessory ? renderAccessory(accessory, skinColor) : ''}
        </svg>
      `;
    }
    
    function renderAccessory(accessory, skinColor) {
      const accessories = {
        'glasses': `
          <rect x="65" y="67" width="20" height="12" fill="none" stroke="#2c3e50" stroke-width="2" rx="4"/>
          <rect x="95" y="67" width="20" height="12" fill="none" stroke="#2c3e50" stroke-width="2" rx="4"/>
          <line x1="85" y1="73" x2="95" y2="73" stroke="#2c3e50" stroke-width="2"/>
        `,
        'headband': `
          <rect x="55" y="50" width="70" height="8" fill="#e74c3c" rx="4"/>
          <circle cx="90" cy="54" r="6" fill="#f39c12"/>
        `,
        'earrings': `
          <circle cx="55" cy="80" r="5" fill="#f39c12" stroke="#d35400" stroke-width="1"/>
          <circle cx="125" cy="80" r="5" fill="#f39c12" stroke="#d35400" stroke-width="1"/>
        `,
        'necklace': `
          <ellipse cx="90" cy="103" rx="20" ry="3" fill="none" stroke="#f39c12" stroke-width="2"/>
          <circle cx="90" cy="108" r="4" fill="#3498db"/>
        `,
        'scarf': `
          <path d="M 65 100 L 90 115 L 115 100 L 110 125 L 90 120 L 70 125 Z" fill="#e74c3c"/>
          <path d="M 90 115 L 85 130 L 95 130 Z" fill="#c0392b"/>
        `
      };
      
      return accessories[accessory] || '';
    }
    
    // ========================================
    // GAME STATE
    // ========================================
    
    let yuanBao = 1000;
    let username = '';
    let dialogueStep = 0;
    let currentLesson = '';
    let wordsLearned = 15;
    let lessonsCompleted = 0;
    let currentStreak = 5;
    let completedLessons = [];
    let playerChoice = null;
    let lessonChoices = {}; // Tracks player choices in lessons (e.g., {numbers: 0})
    let savedDialogues = [];
    
    const savedYuanBao = localStorage.getItem('yuanBao');
    if (!savedYuanBao) {
      localStorage.setItem('yuanBao', yuanBao);
    }
    
    // Load saved dialogues
    const savedDialoguesData = localStorage.getItem('savedDialogues');
    if (savedDialoguesData) {
      savedDialogues = JSON.parse(savedDialoguesData);
    }
    
    const lessons = {
      greetings: {
        title: 'Love at First Sight',
        subtitle: 'Learn greetings and introductions',
        background: 'https://i.pinimg.com/736x/4a/01/90/4a0190274d2cc5ce8933037acf2f6ec3.jpg',
        dialogues: [
          { speaker: 'David (Â§ßË°õ)', chinese: 'Âó®Ôºå‰Ω†ÈúÄË¶ÅÂπ´ÂøôÂóéÔºü', pinyin: 'HƒÅi, n«ê x≈´y√†o bƒÅngm√°ng ma?', english: 'Hi, do you need help?', character: 'david', type: 'dialogue' },
          { speaker: 'Player', chinese: '', pinyin: '', english: '', character: 'phin', type: 'quiz', options: [
            { chinese: 'Âó®ÔºåÊàëËø∑Ë∑Ø‰∫Ü„ÄÇ', pinyin: 'HƒÅi, w«í m√≠l√π le.', english: 'Hi, I\'m lost.' },
            { chinese: 'ÂëÉ‚Ä¶‰∏çÂ•ΩÊÑèÊÄùÔºåÊàëËÅΩ‰∏çÂ§™ÊáÇ„ÄÇ', pinyin: '√à‚Ä¶ b√π h«éo y√¨si, w«í tƒ´ng b√π t√†i d«íng.', english: 'Uh‚Ä¶ sorry, I don\'t really understand.' }
          ], correct: 0 },
          { speaker: 'David (Â§ßË°õ)', chinese: 'Ê≤íÈóú‰øÇ„ÄÇÊàëÂè´Â§ßË°õ„ÄÇ‰Ω†Âë¢Ôºü', pinyin: 'M√©i guƒÅnxi. W«í ji√†o D√†w√®i. N«ê ne?', english: 'No worries. My name is David. And you?', character: 'david', type: 'dialogue' },
          { speaker: 'Player (Phin)', chinese: 'ÊàëÂè´ Phin„ÄÇ', pinyin: 'W«í ji√†o Phin.', english: 'My name is Phin.', character: 'phin', type: 'dialogue' },
          { speaker: 'David (Â§ßË°õ)', chinese: '‰Ω†Â•ΩÔºåPhin„ÄÇ‰Ω†ÂæûÂì™Ë£°‰æÜÔºü', pinyin: 'N«ê h«éo, Phin. N«ê c√≥ng n«él«ê l√°i?', english: 'Nice to meet you, Phin. Where are you from?', character: 'david', type: 'dialogue' },
          { speaker: 'Player (Phin)', chinese: 'Êàë‰æÜËá™Á∑¨Áî∏„ÄÇ', pinyin: 'W«í l√°iz√¨ Mi«éndi√†n.', english: 'I\'m from Myanmar.', character: 'phin', type: 'dialogue' },
          { speaker: 'David (Â§ßË°õ)', chinese: 'ÂñîÔºåÊ≠°Ëøé‰æÜÂè∞Â§ß„ÄÇ', pinyin: '≈å, huƒÅny√≠ng l√°i T√°id√†.', english: 'Oh, welcome to NTU.', character: 'david', type: 'dialogue' },
          { speaker: 'David (Â§ßË°õ)', chinese: 'ÊàëÂ∏∂‰Ω†Ëµ∞Ëµ∞Âêß„ÄÇ', pinyin: 'W«í d√†i n«ê z«íu-z«íu ba.', english: 'Let me show you around.', character: 'david', type: 'dialogue' }
        ]
      },
      numbers: {
        title: 'Night Market',
        subtitle: 'Exploring the night market together',
        background: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR4FH6yzM0VWRjFmwgDdM2PF2Ub9QXv0-3z_w&s',
        dialogues: [
          { speaker: 'David (Â§ßË°õ)', chinese: 'ÈÄôË£°ÊòØÂ§úÂ∏Ç„ÄÇ', pinyin: 'Zh√®l«ê sh√¨ y√®sh√¨.', english: 'This is the night market.', character: 'david', type: 'dialogue' },
          { speaker: 'David (Â§ßË°õ)', chinese: '‰Ω†ÂñúÊ≠°ÂñùÁèçÁè†Â•∂Ëå∂ÂóéÔºü', pinyin: 'N«ê x«êhuƒÅn hƒì zhƒìnzh≈´ n«éich√° ma?', english: 'Do you like bubble tea?', character: 'david', type: 'dialogue' },
          { speaker: 'Player (Phin)', chinese: 'ÂóØÔºåÂñúÊ≠°„ÄÇ', pinyin: 'En, x«êhuƒÅn.', english: 'Yeah, I like it.', character: 'phin', type: 'dialogue' },
          { speaker: 'David (Â§ßË°õ)', chinese: 'ÈÇ£‰Ω†‰∏ÄÂÆöË¶ÅË©¶Ë©¶ÈÄôÂÆ∂„ÄÇ', pinyin: 'N√† n«ê y√≠d√¨ng y√†o sh√¨shi zh√® jiƒÅ.', english: 'Then you have to try this place.', character: 'david', type: 'dialogue' },
          { speaker: '', chinese: '', pinyin: '', english: '', character: '', type: 'image', imageUrl: 'placeholder' },
          { speaker: 'David (Â§ßË°õ)', chinese: '‰∏ãÊ¨°Ë¶Å‰∏çË¶ÅÂÜç‰∏ÄËµ∑Âá∫‰æÜÔºü', pinyin: 'Xi√† c√¨ y√†o b√π y√†o z√†i y√¨q«ê ch≈´l√°i?', english: 'Do you want to go out again next time?', character: 'david', type: 'dialogue' },
          { speaker: 'Player', chinese: '', pinyin: '', english: '', character: 'phin', type: 'choice', options: [
            { chinese: 'Â•ΩÂïä„ÄÇ', pinyin: 'H«éo a.', english: 'Sure.' },
            { chinese: '‰∏çÂ•ΩÊÑèÊÄùÔºå‰∏çË°å„ÄÇ', pinyin: 'B√π h«éo y√¨si, b√π x√≠ng.', english: 'Sorry, no.' }
          ], responses: [
            { speaker: 'David (Â§ßË°õ)', chinese: 'Â§™Â•Ω‰∫ÜÔºÅ', pinyin: 'T√†i h«éo le!', english: 'Hooray!', character: 'david' },
            { speaker: 'David (Â§ßË°õ)', chinese: 'Ê≤íÈóú‰øÇ„ÄÇ', pinyin: 'M√©i guƒÅnxi.', english: "That's okay.", character: 'david' }
          ] }
        ]
      },
      food: {
        title: 'Happy Ending',
        subtitle: 'The moment of truth',
        background: 'https://creator.nightcafe.studio/jobs/WyxKAB2ZhZ3Z4utO5IN5/WyxKAB2ZhZ3Z4utO5IN5--4--0rkj3.jpg',
        dialogues: [
          { speaker: 'David (Â§ßË°õ)', chinese: 'Phin„ÄÇ', pinyin: 'Phin.', english: 'Phin.', character: 'david', type: 'dialogue' },
          { speaker: 'Player (Phin)', chinese: '‚Ä¶?', pinyin: '‚Ä¶?', english: '‚Ä¶?', character: 'phin', type: 'dialogue' },
          { speaker: 'David (Â§ßË°õ)', chinese: 'ÊàëÊÑõ‰Ω†„ÄÇ', pinyin: 'W«í √†i n«ê.', english: 'I love you.', character: 'david', type: 'dialogue' },
          { speaker: 'David (Â§ßË°õ)', chinese: '‰Ω†È°òÊÑèË∑üÊàëÁµêÂ©öÂóéÔºü', pinyin: 'N«ê yu√†ny√¨ gƒìn w«í ji√©h≈´n ma?', english: 'Will you marry me?', character: 'david', type: 'dialogue' },
          { speaker: 'Player', chinese: '', pinyin: '', english: '', character: 'phin', type: 'quiz', options: [
            { chinese: 'ÊàëÈ°òÊÑè„ÄÇ', pinyin: 'W«í yu√†ny√¨.', english: 'I do.' }
          ], correct: 0 },
          { speaker: 'David (Â§ßË°õ)', chinese: 'Â§™Â•Ω‰∫ÜÔºÅ', pinyin: 'T√†i h«éo le!', english: 'Hooray!', character: 'david', type: 'dialogue' },
          { speaker: '', chinese: '', pinyin: '', english: '', character: '', type: 'image', imageUrl: 'https://www.theknot.com/tk-media/images/3bc9b8a6-46a6-42d8-8776-3df7c3bbb77c', emoji: 'üéâ' },
          { speaker: '', chinese: '', pinyin: '', english: '', character: '', type: 'image', imageUrl: 'https://t3.ftcdn.net/jpg/03/27/47/64/360_F_327476437_wUTmsvTLezc2fNh3UmqrOYE7xyWp1fvo.jpg', emoji: '‚ù§Ô∏è', babies: true }
        ]
      },
      directions: {
        title: 'Awkward Encounter',
        subtitle: 'A brief, uncomfortable greeting',
        background: 'https://as1.ftcdn.net/jpg/01/99/19/26/1000_F_199192630_JdSFvcNfBuVafGeJtimTh0mzSffr9ZGJ.jpg',
        dialogues: [
          { speaker: 'David (Â§ßË°õ)', chinese: 'Âó®„ÄÇ', pinyin: 'HƒÅi.', english: 'Hi.', character: 'david', type: 'dialogue' },
          { speaker: 'Player (Phin)', chinese: 'Âó®ÔºåÂ§ßË°õ„ÄÇ', pinyin: 'HƒÅi, D√†w√®i.', english: 'Hi, David.', character: 'phin', type: 'dialogue' },
          { speaker: 'David (Â§ßË°õ)', chinese: 'ÊãúÊãú„ÄÇ', pinyin: 'BƒÅibƒÅi.', english: 'Bye.', character: 'david', type: 'dialogue' },
          { speaker: 'Player (Phin)', chinese: '...ÊãúÊãú„ÄÇ', pinyin: '...BƒÅibƒÅi.', english: '...bye.', character: 'phin', type: 'dialogue' }
        ]
      }
    };

    const avatarOptions = {
      skinTones: [
        { id: 'light', name: 'Light', price: 0 },
        { id: 'medium', name: 'Medium', price: 0 },
        { id: 'tan', name: 'Tan', price: 0 },
        { id: 'dark', name: 'Dark', price: 0 }
      ],
      outfits: [
        { id: 'student', price: 0 },
        { id: 'casual', price: 50 },
        { id: 'formal', price: 80 },
        { id: 'sporty', price: 60 }
      ],
      hair: [
        { id: 'black', name: 'Black', price: 0 },
        { id: 'brown', name: 'Brown', price: 30 },
        { id: 'blonde', name: 'Blonde', price: 40 },
        { id: 'red', name: 'Red', price: 50 },
        { id: 'blue', name: 'Blue', price: 100 },
        { id: 'pink', name: 'Pink', price: 100 }
      ],
      accessories: [
        { id: 'none', price: 0 },
        { id: 'glasses', price: 30 },
        { id: 'headband', price: 25 },
        { id: 'earrings', price: 40 },
        { id: 'necklace', price: 35 },
        { id: 'scarf', price: 45 }
      ]
    };
    
    let selectedAvatar = {
      skinTone: 'light',
      outfit: 'student',
      hair: 'black',
      accessory: 'none'
    };
    
    let ownedItems = {
      skinTones: ['light', 'medium', 'tan', 'dark'],
      outfits: ['student'],
      hair: ['black'],
      accessories: ['none']
    };
    
    function login() {
      const usernameInput = document.getElementById('username-input').value.trim();
      
      if (!usernameInput) {
        const inputElement = document.getElementById('username-input');
        inputElement.style.borderColor = '#f44336';
        setTimeout(() => {
          inputElement.style.borderColor = '#e2e8f0';
        }, 2000);
        return;
      }
      
      username = usernameInput;
      localStorage.setItem('username', username);
      
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('main-app').classList.remove('hidden');
      
      initializeAllIcons();
      loadUserData();
      startNPCMovement();
      startCountdownTimers();
      initializeLessonMap();
      showLessonSelection();
      updateAvatarDisplay();
    }
    
    function loadUserData() {
      const savedYuanBao = localStorage.getItem('yuanBao');
      if (savedYuanBao) {
        yuanBao = parseInt(savedYuanBao);
      } else {
        yuanBao = 1000;
        localStorage.setItem('yuanBao', yuanBao);
      }
      document.getElementById('room-yuan-bao').textContent = yuanBao;
      document.getElementById('world-yuan-bao').textContent = yuanBao;
      
      const savedAvatar = localStorage.getItem('avatar');
      if (savedAvatar) {
        selectedAvatar = JSON.parse(savedAvatar);
      }
      
      const savedOwnedItems = localStorage.getItem('ownedItems');
      if (savedOwnedItems) {
        ownedItems = JSON.parse(savedOwnedItems);
      }
      
      const savedCompletedLessons = localStorage.getItem('completedLessons');
      if (savedCompletedLessons) {
        completedLessons = JSON.parse(savedCompletedLessons);
        updateLessonMap();
      }
      
      const savedLessonChoices = localStorage.getItem('lessonChoices');
      if (savedLessonChoices) {
        lessonChoices = JSON.parse(savedLessonChoices);
        updateLessonMap();
      }
    }
    
    function switchTab(tab) {
      const pages = ['learn-select', 'learn', 'home', 'world', 'dictionary', 'explore'];
      const navItems = ['nav-learn', 'nav-home', 'nav-world', 'nav-dictionary', 'nav-explore'];
      
      pages.forEach(page => {
        const pageElement = document.getElementById(`${page}-page`);
        if (pageElement) {
          if (page === tab) {
            pageElement.classList.remove('hidden');
          } else {
            pageElement.classList.add('hidden');
          }
        }
      });
      
      navItems.forEach(navId => {
        const navElement = document.getElementById(navId);
        if (navElement) {
          if (navId === `nav-${tab}` || (tab === 'learn-select' && navId === 'nav-learn')) {
            navElement.classList.add('active');
          } else {
            navElement.classList.remove('active');
          }
        }
      });
      
      if (tab === 'world') {
        setTimeout(moveNPC, 50);
      }
    }
    
    function showLessonSelection() {
      switchTab('learn-select');
    }
    
    function startLesson(lessonId) {
      const lessonOrder = ['greetings', 'numbers', 'food', 'shopping', 'directions'];
      const lessonIndex = lessonOrder.indexOf(lessonId);
      
      // Check if lesson is unlocked
      if (!isLessonUnlocked(lessonId)) {
        return;
      }
      
      currentLesson = lessonId;
      dialogueStep = 0;
      playerChoice = null;
      
      const lesson = lessons[lessonId];
      if (!lesson) {
        console.error('Lesson not found:', lessonId);
        return;
      }
      
      document.getElementById('scene-title').textContent = lesson.title;
      document.getElementById('scene-subtitle').textContent = lesson.subtitle;

      // Set background image for this lesson
      if (lesson.background) {
        document.getElementById('visual-novel').style.background = `url('${lesson.background}') center/cover no-repeat`;
      }

      // Make sure visual novel container is visible
      document.getElementById('visual-novel').classList.remove('hidden');
      
      switchTab('learn');
      displayDialogue();
    }
    
    function isLessonUnlocked(lessonId) {
      const lessonOrder = ['greetings', 'numbers', 'food', 'shopping', 'directions'];
      const lessonIndex = lessonOrder.indexOf(lessonId);
      
      // Lessons 1-1 and 1-2 are always unlocked (indices 0, 1)
      if (lessonIndex <= 1) {
        return true;
      }
      
      // Lesson 1-3.1 (food) unlocks if player chose option 0 in Lesson 1-2
      if (lessonId === 'food') {
        return completedLessons.includes('numbers') && lessonChoices['numbers'] === 0;
      }
      
      // Lesson 1-3.2 (directions) unlocks if player chose option 1 in Lesson 1-2
      if (lessonId === 'directions') {
        return completedLessons.includes('numbers') && lessonChoices['numbers'] === 1;
      }
      
      // Lesson 1-4 (shopping) unlocks after completing either 1-3.1 or 1-3.2
      if (lessonId === 'shopping') {
        return completedLessons.includes('food') || completedLessons.includes('directions');
      }
      
      // Default: unlock if previous lesson is completed
      const previousLesson = lessonOrder[lessonIndex - 1];
      return completedLessons.includes(previousLesson);
    }
    
    function displayDialogue() {
      const lesson = lessons[currentLesson];
      const dialogue = lesson.dialogues[dialogueStep];
      
      const dialogueBox = document.getElementById('dialogue-box');
      const charactersArea = document.getElementById('characters-area');
      const visualNovel = document.getElementById('visual-novel');
      
      // Clear any existing image moments
      const existingImageMoment = document.querySelector('.image-moment');
      if (existingImageMoment) {
        existingImageMoment.remove();
      }
      
      if (dialogue.type === 'image') {
        // Hide dialogue box and characters
        dialogueBox.style.display = 'none';
        charactersArea.style.display = 'none';
        
        // Create player character SVG
        const playerCharacter = createRPGCharacter(
          selectedAvatar.skinTone,
          selectedAvatar.outfit,
          selectedAvatar.hair,
          selectedAvatar.accessory === 'none' ? null : selectedAvatar.accessory
        );
        
        // Create David character SVG
        const davidCharacter = createMaleCharacter();
        
        // Create image moment with image and characters
        const imageMoment = document.createElement('div');
        imageMoment.className = 'image-moment';
        const imageUrl = dialogue.imageUrl && dialogue.imageUrl !== 'placeholder'
          ? dialogue.imageUrl
          : 'https://imgcdn.stablediffusionweb.com/2024/11/19/962023e5-9415-4257-b7ae-34f92d95529f.jpg';

        imageMoment.innerHTML = `
          <div style="width: 600px; max-width: 90vw; height: 400px; background: url('${imageUrl}') center/cover no-repeat; border-radius: 24px; box-shadow: 0 16px 48px rgba(0,0,0,0.4); position: relative; overflow: visible; filter: blur(1.5px);">
          </div>
          <div style="position: absolute; bottom: 30%; left: 40%; transform: translateX(-50%); width: 180px; height: 280px; z-index: 10; filter: drop-shadow(0 8px 24px rgba(0,0,0,0.4));">
            ${davidCharacter}
          </div>
          <div style="position: absolute; bottom: 30%; right: 40%; transform: translateX(50%); width: 180px; height: 280px; z-index: 10; filter: drop-shadow(0 8px 24px rgba(0,0,0,0.4));">
            ${playerCharacter}
          </div>
          ${dialogue.babies ? `
          <div style="position: absolute; bottom: 30%; left: 25%; transform: translateX(-50%); font-size: 64px; z-index: 11; filter: drop-shadow(0 4px 12px rgba(0,0,0,0.5));">
            üë∂
          </div>
          <div style="position: absolute; bottom: 30%; right: 25%; transform: translateX(50%); font-size: 64px; z-index: 11; filter: drop-shadow(0 4px 12px rgba(0,0,0,0.5));">
            üë∂
          </div>
          ` : ''}
          <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); margin-top: -236px; font-size: 72px; filter: drop-shadow(0 4px 12px rgba(0,0,0,0.5)); z-index: 15;">
            ${dialogue.emoji || 'üì∏'}
          </div>
          <button class="continue-btn" onclick="continueStory()">Continue ${getIcon('ui.arrow')}</button>
        `;
        visualNovel.appendChild(imageMoment);
        
      } else {
        // Show dialogue box and characters
        dialogueBox.style.display = 'block';
        charactersArea.style.display = 'flex';
        
        document.getElementById('speaker-name').textContent = dialogue.speaker;
        
        // Remove any existing save button
        const existingSaveBtn = dialogueBox.querySelector('.save-dialogue-btn');
        if (existingSaveBtn) {
          existingSaveBtn.remove();
        }
        
        if (dialogue.type === 'choice') {
          let optionsHTML = '';
          dialogue.options.forEach((option, index) => {
            optionsHTML += `
              <button class="dialogue-option-btn" onclick="makeChoice(${index})">
                <div style="font-size: 18px; margin-bottom: 4px;">${option.chinese}</div>
                <div style="font-size: 12px; color: #81c784; margin-bottom: 4px;">${option.pinyin}</div>
                <div style="font-size: 14px; opacity: 0.9;">${option.english}</div>
              </button>
            `;
          });
          
          document.getElementById('dialogue-content').innerHTML = `
            <div class="dialogue-options">${optionsHTML}</div>
          `;
          document.getElementById('continue-btn').classList.add('hidden');
          
        } else if (dialogue.type === 'quiz') {
          let optionsHTML = '';
          dialogue.options.forEach((option, index) => {
            optionsHTML += `
              <button class="dialogue-option-btn" onclick="checkDialogueAnswer(${index}, ${dialogue.correct})">
                <div style="font-size: 18px; margin-bottom: 4px;">${option.chinese}</div>
                <div style="font-size: 12px; color: #81c784; margin-bottom: 4px;">${option.pinyin}</div>
                <div style="font-size: 14px; opacity: 0.9;">${option.english}</div>
              </button>
            `;
          });
          
          document.getElementById('dialogue-content').innerHTML = `
            <div class="dialogue-options">${optionsHTML}</div>
          `;
          document.getElementById('continue-btn').classList.add('hidden');
          
        } else {
          document.getElementById('dialogue-content').innerHTML = `
            <div class="chinese-text">${dialogue.chinese} <span style="display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; background: rgba(255, 215, 0, 0.2); border: 2px solid rgba(255, 215, 0, 0.4); border-radius: 50%; cursor: pointer; margin-left: 8px; transition: all 0.3s ease; vertical-align: middle;" onmouseover="this.style.background='rgba(255, 215, 0, 0.35)'; this.style.transform='scale(1.1)'" onmouseout="this.style.background='rgba(255, 215, 0, 0.2)'; this.style.transform='scale(1)'">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M11 5L6 9H2V15H6L11 19V5Z" fill="#ffd700" stroke="#ffd700" stroke-width="2" stroke-linejoin="round"/>
                <path d="M15.54 8.46C16.4774 9.39764 17.0039 10.6692 17.0039 11.995C17.0039 13.3208 16.4774 14.5924 15.54 15.53" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><animate attributeName="opacity" values="0.3;1;0.3" dur="1.5s" repeatCount="indefinite"/></path>
                <path d="M19.07 4.93C20.9447 6.80528 21.9979 9.34836 21.9979 12C21.9979 14.6516 20.9447 17.1947 19.07 19.07" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><animate attributeName="opacity" values="0.3;1;0.3" dur="1.5s" begin="0.3s" repeatCount="indefinite"/></path>
              </svg>
            </span></div>
            <div class="pinyin-text">${dialogue.pinyin}</div>
            <div class="english-text">${dialogue.english}</div>
          `;
          document.getElementById('continue-btn').classList.remove('hidden');
          
          // Add save button for regular dialogues (not choices or quizzes)
          const saveBtn = document.createElement('button');
          saveBtn.className = 'save-dialogue-btn';
          saveBtn.innerHTML = '‚≠ê';
          saveBtn.onclick = () => saveDialogue(dialogue);
          
          // Check if this dialogue is already saved
          const isSaved = savedDialogues.some(saved => 
            saved.chinese === dialogue.chinese && 
            saved.speaker === dialogue.speaker
          );
          if (isSaved) {
            saveBtn.classList.add('saved');
          }
          
          dialogueBox.appendChild(saveBtn);
        }
        
        document.getElementById('character-phin').classList.toggle('speaking', dialogue.character === 'phin');
        document.getElementById('character-david').classList.toggle('speaking', dialogue.character === 'david');
      }
    }
    
    function saveDialogue(dialogue) {
      // Check if already saved
      const alreadySaved = savedDialogues.some(saved => 
        saved.chinese === dialogue.chinese && 
        saved.speaker === dialogue.speaker
      );
      
      if (alreadySaved) {
        // If already saved, unsave it
        savedDialogues = savedDialogues.filter(saved => 
          !(saved.chinese === dialogue.chinese && saved.speaker === dialogue.speaker)
        );
      } else {
        // Save the dialogue
        savedDialogues.push({
          speaker: dialogue.speaker,
          chinese: dialogue.chinese,
          pinyin: dialogue.pinyin,
          english: dialogue.english
        });
      }
      
      // Save to localStorage
      localStorage.setItem('savedDialogues', JSON.stringify(savedDialogues));
      
      // Update the save button appearance
      const saveBtn = document.querySelector('.save-dialogue-btn');
      if (saveBtn) {
        saveBtn.classList.toggle('saved', !alreadySaved);
      }
      
      // Update the saved tab
      updateSavedTab();
    }
    
    function updateSavedTab() {
      const savedTabContent = document.getElementById('dict-tab-saved');
      const emptyState = savedTabContent.querySelector('.empty-state');
      
      // Remove all existing dialogue entries
      const existingEntries = savedTabContent.querySelectorAll('.dialogue-entry');
      existingEntries.forEach(entry => entry.remove());
      
      if (savedDialogues.length === 0) {
        emptyState.classList.remove('hidden');
      } else {
        emptyState.classList.add('hidden');
        
        // Add all saved dialogues
        savedDialogues.forEach((dialogue, index) => {
          const entryDiv = document.createElement('div');
          entryDiv.className = 'dialogue-entry';
          entryDiv.innerHTML = `
            <div class="dialogue-speaker">${dialogue.speaker}</div>
            <div class="dialogue-content">
              <div class="word-chinese">${dialogue.chinese}</div>
              <div class="word-pinyin">${dialogue.pinyin}</div>
              <div class="word-english">${dialogue.english}</div>
            </div>
            <button class="unsave-btn" onclick="unsaveDialogue(${index})">‚úï</button>
          `;
          savedTabContent.insertBefore(entryDiv, emptyState);
        });
      }
    }
    
    function makeChoice(choiceIndex) {
      playerChoice = choiceIndex;
      const buttons = document.querySelectorAll('.dialogue-option-btn');
      
      buttons.forEach((btn, idx) => {
        btn.style.pointerEvents = 'none';
        if (idx === choiceIndex) {
          btn.style.background = 'rgba(255, 255, 255, 0.4)';
          btn.style.borderColor = 'white';
        }
      });
      
      // Store choice for this lesson
      lessonChoices[currentLesson] = choiceIndex;
      localStorage.setItem('lessonChoices', JSON.stringify(lessonChoices));
      
      // Store the choice index for emoji display later
      window.lastChoiceIndex = choiceIndex;
      
      setTimeout(() => {
        continueStory();
      }, 800);
    }
    
    function checkDialogueAnswer(selected, correct) {
      const buttons = document.querySelectorAll('.dialogue-option-btn');
      
      buttons.forEach((btn, idx) => {
        btn.style.pointerEvents = 'none';
        if (idx === selected) {
          btn.style.background = 'rgba(255, 255, 255, 0.4)';
          btn.style.borderColor = 'white';
        }
      });
      
      yuanBao += 5;
      wordsLearned += 1;
      
      localStorage.setItem('yuanBao', yuanBao);
      document.getElementById('room-yuan-bao').textContent = yuanBao;
      document.getElementById('world-yuan-bao').textContent = yuanBao;
      
      setTimeout(() => {
        continueStory();
      }, 800);
    }
    
    function continueStory() {
      const lesson = lessons[currentLesson];
      const currentDialogue = lesson.dialogues[dialogueStep];
      
      // If current dialogue is a choice with responses, show the response based on player's choice
      if (currentDialogue && currentDialogue.type === 'choice' && playerChoice !== null && currentDialogue.responses) {
        const response = currentDialogue.responses[playerChoice];
        
        // Create a temporary dialogue to display the response
        document.getElementById('speaker-name').textContent = response.speaker;
        document.getElementById('dialogue-content').innerHTML = `
          <div class="chinese-text">${response.chinese}</div>
          <div class="pinyin-text">${response.pinyin}</div>
          <div class="english-text">${response.english}</div>
        `;
        document.getElementById('continue-btn').classList.remove('hidden');
        
        document.getElementById('character-phin').classList.toggle('speaking', response.character === 'phin');
        document.getElementById('character-david').classList.toggle('speaking', response.character === 'david');
        
        // Show emoji on David's avatar for lesson 1-2 choice responses
        if (currentLesson === 'numbers' && response.character === 'david') {
          const davidAvatar = document.getElementById('character-david');
          
          // Remove any existing emoji
          const existingEmoji = davidAvatar.querySelector('.character-emoji');
          if (existingEmoji) {
            existingEmoji.remove();
          }
          
          // Add emoji based on player's choice
          const emojiElement = document.createElement('div');
          emojiElement.className = 'character-emoji';
          
          if (window.lastChoiceIndex === 0) {
            // Choice 0: "Sure" - Show heart emoji
            emojiElement.textContent = '‚ù§Ô∏è';
          } else if (window.lastChoiceIndex === 1) {
            // Choice 1: "Sorry, no" - Show heartbreak emoji
            emojiElement.textContent = 'üíî';
          }
          
          davidAvatar.appendChild(emojiElement);
        }
        
        // Reset player choice and move forward
        playerChoice = null;
        dialogueStep++;
        
        // After showing the response, the next continue will complete the lesson
        return;
      }
      
      // Move to next dialogue
      dialogueStep++;
      
      // Check if there are more dialogues AND current dialogue exists
      if (dialogueStep < lesson.dialogues.length && lesson.dialogues[dialogueStep]) {
        displayDialogue();
      } else {
        completeLesson();
      }
    }
    
    function completeLesson() {
      lessonsCompleted++;
      
      if (!completedLessons.includes(currentLesson)) {
        completedLessons.push(currentLesson);
        localStorage.setItem('completedLessons', JSON.stringify(completedLessons));
      }
      
      updateLessonMap();
      
      document.getElementById('visual-novel').classList.add('hidden');
      switchTab('learn-select');
      
      const modalBody = document.getElementById('modal-body');
      modalBody.innerHTML = `
        <h2 class="modal-title">${getIcon('ui.party')} Lesson Complete! ${getIcon('ui.party')}</h2>
        <div class="stats-grid">
          <div class="stat-item">
            <span class="stat-label">Gold Earned</span>
            <span class="stat-value">+5 ${getIcon('ui.coin')}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Words Learned</span>
            <span class="stat-value">+1 ${getIcon('nav.learn')}</span>
          </div>
        </div>
      `;
      document.getElementById('modal-overlay').classList.remove('hidden');
    }
    
    function updateLessonMap() {
      const lessonOrder = ['greetings', 'numbers', 'food', 'shopping', 'directions'];
      const nodes = document.querySelectorAll('.lesson-node');
      
      nodes.forEach((node, index) => {
        const lessonId = lessonOrder[index];
        const circle = node.querySelector('.node-circle');
        
        if (isLessonUnlocked(lessonId)) {
          circle.classList.remove('locked');
        } else {
          circle.classList.add('locked');
        }
      });
    }
    
    function initializeLessonMap() {
      updateLessonMap();
    }
    
    function backToLessons() {
      switchTab('learn-select');
    }
    
    function openModal(type) {
      const modalBody = document.getElementById('modal-body');
      
      if (type === 'character') {
        const characterPreview = createRPGCharacter(
          selectedAvatar.skinTone,
          selectedAvatar.outfit,
          selectedAvatar.hair,
          selectedAvatar.accessory === 'none' ? null : selectedAvatar.accessory
        );
        
        // Initialize life sim stats if not exist
        const lifeStats = JSON.parse(localStorage.getItem('lifeStats')) || {
          attractiveness: 50,
          confidence: 50,
          intelligence: 50,
          charisma: 50,
          creativity: 50,
          socialSkills: 50,
          luck: 50,
          energy: 100
        };
        localStorage.setItem('lifeStats', JSON.stringify(lifeStats));

        // Calculate language stats
        const vocabulary = wordsLearned;
        const fluency = Math.min(100, Math.floor((wordsLearned * 2 + lessonsCompleted * 5)));
        const comprehension = Math.min(100, lessonsCompleted * 10);
        const culturalKnowledge = Math.min(100, Math.floor(wordsLearned * 1.5));

        modalBody.innerHTML = `
          <h2 class="modal-title">${getIcon('ui.trophy')} Character Stats</h2>
          <div class="character-preview">${characterPreview}</div>
          <div style="text-align: center; margin-bottom: 32px;">
            <h3 style="margin: 0 0 4px; color: #2d3748; font-size: 28px;">${username}</h3>
            <p style="margin: 0; color: #718096; font-size: 16px;">Level ${Math.floor(wordsLearned / 5) + 1} Learner</p>
            <p style="margin: 8px 0 0; color: #ffa500; font-size: 18px; font-weight: 600;">${getIcon('ui.coin')} ${yuanBao} Gold</p>
          </div>

          <div class="stats-columns">
            <div class="stats-section">
              <h3>üìö Language Stats</h3>
              <div class="stat-bar">
                <div class="stat-bar-header">
                  <span class="stat-bar-label">üìñ Vocabulary Power</span>
                  <span class="stat-bar-value">${vocabulary}</span>
                </div>
                <div class="stat-bar-track">
                  <div class="stat-bar-fill" style="width: ${Math.min(100, vocabulary)}%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);"></div>
                </div>
              </div>
              <div class="stat-bar">
                <div class="stat-bar-header">
                  <span class="stat-bar-label">‚ö° Fluency</span>
                  <span class="stat-bar-value">${fluency}/100</span>
                </div>
                <div class="stat-bar-track">
                  <div class="stat-bar-fill" style="width: ${fluency}%; background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);"></div>
                </div>
              </div>
              <div class="stat-bar">
                <div class="stat-bar-header">
                  <span class="stat-bar-label">üß† Comprehension</span>
                  <span class="stat-bar-value">${comprehension}/100</span>
                </div>
                <div class="stat-bar-track">
                  <div class="stat-bar-fill" style="width: ${comprehension}%; background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);"></div>
                </div>
              </div>
              <div class="stat-bar">
                <div class="stat-bar-header">
                  <span class="stat-bar-label">üèÆ Cultural Knowledge</span>
                  <span class="stat-bar-value">${culturalKnowledge}/100</span>
                </div>
                <div class="stat-bar-track">
                  <div class="stat-bar-fill" style="width: ${culturalKnowledge}%; background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);"></div>
                </div>
              </div>
              <div style="margin-top: 16px; padding: 12px; background: #f7fafc; border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                  <span style="font-size: 14px; color: #718096;">Current Streak</span>
                  <span style="font-size: 14px; font-weight: 700; color: #2d3748;">${getIcon('ui.fire')} ${currentStreak} days</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                  <span style="font-size: 14px; color: #718096;">Total XP</span>
                  <span style="font-size: 14px; font-weight: 700; color: #2d3748;">${getIcon('ui.star')} ${wordsLearned * 10 + lessonsCompleted * 50}</span>
                </div>
              </div>
            </div>

            <div class="stats-section">
              <h3>‚ú® Life Stats</h3>
              <div class="stat-bar">
                <div class="stat-bar-header">
                  <span class="stat-bar-label">üíñ Attractiveness</span>
                  <span class="stat-bar-value">${lifeStats.attractiveness}/100</span>
                </div>
                <div class="stat-bar-track">
                  <div class="stat-bar-fill" style="width: ${lifeStats.attractiveness}%; background: linear-gradient(90deg, #fa709a 0%, #fee140 100%);"></div>
                </div>
              </div>
              <div class="stat-bar">
                <div class="stat-bar-header">
                  <span class="stat-bar-label">üí™ Confidence</span>
                  <span class="stat-bar-value">${lifeStats.confidence}/100</span>
                </div>
                <div class="stat-bar-track">
                  <div class="stat-bar-fill" style="width: ${lifeStats.confidence}%; background: linear-gradient(90deg, #ff9a56 0%, #ff6a88 100%);"></div>
                </div>
              </div>
              <div class="stat-bar">
                <div class="stat-bar-header">
                  <span class="stat-bar-label">üéì Intelligence</span>
                  <span class="stat-bar-value">${lifeStats.intelligence}/100</span>
                </div>
                <div class="stat-bar-track">
                  <div class="stat-bar-fill" style="width: ${lifeStats.intelligence}%; background: linear-gradient(90deg, #a8edea 0%, #fed6e3 100%);"></div>
                </div>
              </div>
              <div class="stat-bar">
                <div class="stat-bar-header">
                  <span class="stat-bar-label">üí¨ Charisma</span>
                  <span class="stat-bar-value">${lifeStats.charisma}/100</span>
                </div>
                <div class="stat-bar-track">
                  <div class="stat-bar-fill" style="width: ${lifeStats.charisma}%; background: linear-gradient(90deg, #fdcbf1 0%, #e6dee9 100%);"></div>
                </div>
              </div>
              <div class="stat-bar">
                <div class="stat-bar-header">
                  <span class="stat-bar-label">üé® Creativity</span>
                  <span class="stat-bar-value">${lifeStats.creativity}/100</span>
                </div>
                <div class="stat-bar-track">
                  <div class="stat-bar-fill" style="width: ${lifeStats.creativity}%; background: linear-gradient(90deg, #ffecd2 0%, #fcb69f 100%);"></div>
                </div>
              </div>
              <div class="stat-bar">
                <div class="stat-bar-header">
                  <span class="stat-bar-label">üë• Social Skills</span>
                  <span class="stat-bar-value">${lifeStats.socialSkills}/100</span>
                </div>
                <div class="stat-bar-track">
                  <div class="stat-bar-fill" style="width: ${lifeStats.socialSkills}%; background: linear-gradient(90deg, #ff6e7f 0%, #bfe9ff 100%);"></div>
                </div>
              </div>
              <div class="stat-bar">
                <div class="stat-bar-header">
                  <span class="stat-bar-label">üçÄ Luck</span>
                  <span class="stat-bar-value">${lifeStats.luck}/100</span>
                </div>
                <div class="stat-bar-track">
                  <div class="stat-bar-fill" style="width: ${lifeStats.luck}%; background: linear-gradient(90deg, #c1dfc4 0%, #deecdd 100%);"></div>
                </div>
              </div>
              <div class="stat-bar">
                <div class="stat-bar-header">
                  <span class="stat-bar-label">‚ö° Energy</span>
                  <span class="stat-bar-value">${lifeStats.energy}/100</span>
                </div>
                <div class="stat-bar-track">
                  <div class="stat-bar-fill" style="width: ${lifeStats.energy}%; background: linear-gradient(90deg, #ffd89b 0%, #19547b 100%);"></div>
                </div>
              </div>
            </div>
          </div>
        `;
      } else if (type === 'wardrobe') {
        const characterPreview = createRPGCharacter(
          selectedAvatar.skinTone,
          selectedAvatar.outfit,
          selectedAvatar.hair,
          selectedAvatar.accessory === 'none' ? null : selectedAvatar.accessory
        );
        
        const bodyColors = {
          'light': '#ffd1b3',
          'medium': '#d4a373',
          'tan': '#b08968',
          'dark': '#8b6f47'
        };
        
        const hairColorMap = {
          'black': '#2c2c2c',
          'brown': '#8b6f47',
          'blonde': '#f4d03f',
          'red': '#d63447',
          'blue': '#5dade2',
          'pink': '#ff87c3'
        };
        
        modalBody.innerHTML = `
          <div class="wardrobe-modal">
            <h2 class="modal-title">${getIcon('room.wardrobe')} Customize Character</h2>
            <div class="character-preview">${characterPreview}</div>
            <div style="text-align: center; margin-bottom: 12px;">
              <span style="font-size: 18px; color: #ffa500; font-weight: 600;">${getIcon('ui.coin')} ${yuanBao} Gold</span>
            </div>
            
            <div class="wardrobe-section">
              <h3>Skin Tone</h3>
              <div class="customization-grid">
                ${avatarOptions.skinTones.map(item => {
                  const isOwned = ownedItems.skinTones.includes(item.id);
                  const isSelected = selectedAvatar.skinTone === item.id;
                  return `
                    <div class="custom-option ${isSelected ? 'selected' : ''}" onclick="selectAvatarPart('skinTone', '${item.id}', ${item.price})">
                      <div class="option-visual">
                        <div class="option-color-swatch" style="background: ${bodyColors[item.id]};"></div>
                      </div>
                      <div class="option-price">${isOwned || item.price === 0 ? getIcon('ui.checkmark') + ' Owned' : getIcon('ui.coin') + ' ' + item.price}</div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
            
            <div class="wardrobe-section">
              <h3>Outfit</h3>
              <div class="customization-grid">
                ${avatarOptions.outfits.map(item => {
                  const isOwned = ownedItems.outfits.includes(item.id);
                  const canAfford = yuanBao >= item.price || isOwned || item.price === 0;
                  const isSelected = selectedAvatar.outfit === item.id;
                  const lockedClass = !canAfford ? 'locked' : '';
                  return `
                    <div class="custom-option ${isSelected ? 'selected' : ''} ${lockedClass}" onclick="selectAvatarPart('outfit', '${item.id}', ${item.price})">
                      <div class="option-visual">
                        <div class="option-emoji">${getIcon('wardrobe.outfits.' + item.id)}</div>
                      </div>
                      <div class="option-price">${isOwned || item.price === 0 ? getIcon('ui.checkmark') + ' Owned' : getIcon('ui.coin') + ' ' + item.price}</div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
            
            <div class="wardrobe-section">
              <h3>Hair Color</h3>
              <div class="customization-grid">
                ${avatarOptions.hair.map(item => {
                  const isOwned = ownedItems.hair.includes(item.id);
                  const canAfford = yuanBao >= item.price || isOwned || item.price === 0;
                  const isSelected = selectedAvatar.hair === item.id;
                  const lockedClass = !canAfford ? 'locked' : '';
                  return `
                    <div class="custom-option ${isSelected ? 'selected' : ''} ${lockedClass}" onclick="selectAvatarPart('hair', '${item.id}', ${item.price})">
                      <div class="option-visual">
                        <div class="option-color-swatch" style="background: ${hairColorMap[item.id]};"></div>
                      </div>
                      <div class="option-price">${isOwned || item.price === 0 ? getIcon('ui.checkmark') + ' Owned' : getIcon('ui.coin') + ' ' + item.price}</div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
            
            <div class="wardrobe-section">
              <h3>Accessories</h3>
              <div class="customization-grid">
                ${avatarOptions.accessories.map(item => {
                  const isOwned = ownedItems.accessories.includes(item.id);
                  const canAfford = yuanBao >= item.price || isOwned || item.price === 0;
                  const isSelected = selectedAvatar.accessory === item.id;
                  const lockedClass = !canAfford ? 'locked' : '';
                  return `
                    <div class="custom-option ${isSelected ? 'selected' : ''} ${lockedClass}" onclick="selectAvatarPart('accessory', '${item.id}', ${item.price})">
                      <div class="option-visual">
                        <div class="option-emoji">${getIcon('wardrobe.accessories.' + item.id)}</div>
                      </div>
                      <div class="option-price">${isOwned || item.price === 0 ? getIcon('ui.checkmark') + ' Owned' : getIcon('ui.coin') + ' ' + item.price}</div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          </div>
        `;
      } else if (type === 'progress') {
        modalBody.innerHTML = `
          <h2 class="modal-title">${getIcon('room.computer')} Your Progress</h2>
          <div class="stats-grid">
            <div class="stat-item">
              <span class="stat-label">Words Learned</span>
              <span class="stat-value">${wordsLearned}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Lessons Completed</span>
              <span class="stat-value">${lessonsCompleted}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Current Streak</span>
              <span class="stat-value">${currentStreak} ${getIcon('ui.fire')}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Gold</span>
              <span class="stat-value">${yuanBao} ${getIcon('ui.coin')}</span>
            </div>
          </div>
        `;
      } else if (type === 'achievements') {
        modalBody.innerHTML = `
          <h2 class="modal-title">${getIcon('ui.trophy')} Achievements</h2>
          <div class="achievement-item">
            <div class="achievement-icon">${getIcon('ui.star')}</div>
            <div class="achievement-info">
              <h3 class="achievement-name">First Steps</h3>
              <p class="achievement-desc">Complete your first lesson</p>
            </div>
          </div>
          <div class="achievement-item">
            <div class="achievement-icon">${getIcon('ui.fire')}</div>
            <div class="achievement-info">
              <h3 class="achievement-name">On Fire</h3>
              <p class="achievement-desc">Maintain a 5-day streak</p>
            </div>
          </div>
          <div class="achievement-item">
            <div class="achievement-icon">${getIcon('nav.learn')}</div>
            <div class="achievement-info">
              <h3 class="achievement-name">Word Master</h3>
              <p class="achievement-desc">Learn 15 new words</p>
            </div>
          </div>
        `;
      } else if (type === 'settings') {
        modalBody.innerHTML = `
          <h2 class="modal-title">${getIcon('ui.gear')} Settings</h2>
          <div class="stats-grid">
            <div class="stat-item">
              <span class="stat-label">Username</span>
              <span class="stat-value">${username}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Version</span>
              <span class="stat-value">1.0</span>
            </div>
          </div>
        `;
      }
      
      document.getElementById('modal-overlay').classList.remove('hidden');
    }
    
    function selectAvatarPart(type, value, price) {
      const categoryMap = {
        'skinTone': 'skinTones',
        'outfit': 'outfits',
        'hair': 'hair',
        'accessory': 'accessories'
      };
      
      const category = categoryMap[type];
      const isOwned = ownedItems[category].includes(value);
      
      if (!isOwned && price > 0 && yuanBao < price) {
        return;
      }
      
      if (!isOwned && price > 0) {
        yuanBao -= price;
        localStorage.setItem('yuanBao', yuanBao);
        document.getElementById('room-yuan-bao').textContent = yuanBao;
      document.getElementById('world-yuan-bao').textContent = yuanBao;
        
        ownedItems[category].push(value);
        localStorage.setItem('ownedItems', JSON.stringify(ownedItems));
      }
      
      selectedAvatar[type] = value;
      updateAvatarDisplay();
      localStorage.setItem('avatar', JSON.stringify(selectedAvatar));
      openModal('wardrobe');
    }
    
    function updateAvatarDisplay() {
      const characterSVG = createRPGCharacter(
        selectedAvatar.skinTone,
        selectedAvatar.outfit,
        selectedAvatar.hair,
        selectedAvatar.accessory === 'none' ? null : selectedAvatar.accessory
      );
      
      const roomAvatar = document.getElementById('room-avatar');
      if (roomAvatar) {
        roomAvatar.innerHTML = characterSVG;
      }
      
      updateConversationAvatar();
    }
    
    function updateDavidAvatar() {
      const davidAvatar = document.getElementById('char-david-avatar');
      if (davidAvatar) {
        const davidCharacter = createMaleCharacter();
        davidAvatar.innerHTML = davidCharacter;
      }
    }
    
    function createMaleCharacter() {
      const skinColor = '#ffd1b3';
      const hairColor = '#2c2c2c';
      const outfitPrimary = '#4a90e2';
      const outfitSecondary = '#2c3e50';
      
      return `
        <svg viewBox="0 0 180 280" xmlns="http://www.w3.org/2000/svg" style="width: 100%; height: 100%;">
          <!-- Shadow -->
          <ellipse cx="90" cy="275" rx="50" ry="8" fill="rgba(0,0,0,0.2)"/>
          
          <!-- HAIR BACK LAYER -->
          <ellipse cx="90" cy="70" rx="40" ry="42" fill="${hairColor}"/>
          <path d="M 52 50 Q 48 65, 45 85 Q 54 75, 55 50 Z" fill="${hairColor}"/>
          <path d="M 128 50 Q 132 65, 135 85 Q 126 75, 125 50 Z" fill="${hairColor}"/>
          
          <!-- Legs -->
          <rect x="68" y="160" width="20" height="110" fill="${outfitSecondary}" rx="10"/>
          <rect x="92" y="160" width="20" height="110" fill="${outfitSecondary}" rx="10"/>
          <line x1="78" y1="165" x2="78" y2="270" stroke="rgba(0,0,0,0.2)" stroke-width="1"/>
          <line x1="102" y1="165" x2="102" y2="270" stroke="rgba(0,0,0,0.2)" stroke-width="1"/>
          
          <!-- Shoes -->
          <ellipse cx="78" cy="270" rx="15" ry="7" fill="#1a1a1a"/>
          <ellipse cx="102" cy="270" rx="15" ry="7" fill="#1a1a1a"/>
          <ellipse cx="78" cy="268" rx="11" ry="5" fill="#333333"/>
          <ellipse cx="102" cy="268" rx="11" ry="5" fill="#333333"/>
          
          <!-- Body - Casual shirt -->
          <rect x="58" y="100" width="64" height="75" fill="${outfitPrimary}" rx="4"/>
          <ellipse cx="90" cy="175" rx="32" ry="4" fill="rgba(0,0,0,0.1)"/>
          <ellipse cx="90" cy="100" rx="16" ry="6" fill="${skinColor}"/>
          
          <!-- Shirt collar -->
          <path d="M 75 100 L 70 108 L 80 108 Z" fill="${outfitPrimary}" stroke="white" stroke-width="1"/>
          <path d="M 105 100 L 110 108 L 100 108 Z" fill="${outfitPrimary}" stroke="white" stroke-width="1"/>
          
          <!-- Shirt pocket -->
          <rect x="95" y="115" width="18" height="16" fill="rgba(0,0,0,0.1)" rx="2"/>
          <line x1="95" y1="118" x2="113" y2="118" stroke="rgba(0,0,0,0.2)" stroke-width="0.5"/>
          
          <!-- Arms -->
          <rect x="46" y="105" width="14" height="28" fill="${outfitPrimary}" rx="7"/>
          <rect x="120" y="105" width="14" height="28" fill="${outfitPrimary}" rx="7"/>
          <ellipse cx="53" cy="133" rx="7" ry="5" fill="${outfitPrimary}"/>
          <ellipse cx="127" cy="133" rx="7" ry="5" fill="${outfitPrimary}"/>
          
          <!-- Forearms -->
          <rect x="45" y="128" width="12" height="50" fill="${skinColor}" rx="6"/>
          <rect x="123" y="128" width="12" height="50" fill="${skinColor}" rx="6"/>
          
          <!-- Hands -->
          <circle cx="45" cy="183" r="9" fill="${skinColor}"/>
          <circle cx="135" cy="183" r="9" fill="${skinColor}"/>
          
          <!-- Neck -->
          <rect x="80" y="92" width="20" height="20" fill="${skinColor}" rx="10"/>
          
          <!-- Head -->
          <ellipse cx="90" cy="68" rx="32" ry="34" fill="${skinColor}"/>
          
          <!-- Ears -->
          <ellipse cx="60" cy="70" rx="6" ry="10" fill="${skinColor}"/>
          <ellipse cx="120" cy="70" rx="6" ry="10" fill="${skinColor}"/>
          <ellipse cx="61" cy="70" rx="3" ry="6" fill="#ffc299"/>
          <ellipse cx="119" cy="70" rx="3" ry="6" fill="#ffc299"/>
          
          <!-- Eyes -->
          <ellipse cx="75" cy="66" rx="6" ry="7" fill="white"/>
          <ellipse cx="105" cy="66" rx="6" ry="7" fill="white"/>
          <circle cx="76" cy="67" r="4.5" fill="#3d2817"/>
          <circle cx="106" cy="67" r="4.5" fill="#3d2817"/>
          <circle cx="77" cy="65" r="2" fill="white"/>
          <circle cx="107" cy="65" r="2" fill="white"/>
          
          <!-- Eyebrows (thicker/straighter for masculine look) -->
          <path d="M 66 58 Q 75 57, 84 58" stroke="#2c2c2c" stroke-width="2" fill="none" stroke-linecap="round"/>
          <path d="M 96 58 Q 105 57, 114 58" stroke="#2c2c2c" stroke-width="2" fill="none" stroke-linecap="round"/>
          
          <!-- Nose (more defined) -->
          <path d="M 90 72 L 90 82" stroke="${skinColor}" stroke-width="2" fill="none" stroke-linecap="round" opacity="0.4"/>
          <path d="M 90 82 L 85 84" stroke="${skinColor}" stroke-width="1.5" fill="none" stroke-linecap="round" opacity="0.3"/>
          <path d="M 90 82 L 95 84" stroke="${skinColor}" stroke-width="1.5" fill="none" stroke-linecap="round" opacity="0.3"/>
          <ellipse cx="87" cy="83" rx="2.5" ry="2" fill="${skinColor}" opacity="0.4"/>
          <ellipse cx="93" cy="83" rx="2.5" ry="2" fill="${skinColor}" opacity="0.4"/>
          
          <!-- Smile -->
          <path d="M 75 88 Q 90 94, 105 88" stroke="#d99" stroke-width="2" fill="none" stroke-linecap="round"/>
          
          <!-- HAIR FRONT LAYER (short, styled) -->
          <path d="M 58 45 Q 70 32, 90 30 Q 110 32, 122 45 Q 112 48, 90 46 Q 68 48, 58 45 Z" fill="${hairColor}"/>
          <path d="M 90 30 Q 85 38, 82 46" stroke="${hairColor}" stroke-width="3" fill="none"/>
          <path d="M 90 30 Q 95 38, 98 46" stroke="${hairColor}" stroke-width="3" fill="none"/>
          <path d="M 75 38 Q 78 42, 82 45" stroke="${hairColor}" stroke-width="2.5" fill="none"/>
          <path d="M 105 38 Q 102 42, 98 45" stroke="${hairColor}" stroke-width="2.5" fill="none"/>
        </svg>
      `;
    }
    
    function updateConversationAvatar() {
      const phinAvatar = document.getElementById('char-phin-avatar');
      if (phinAvatar) {
        const miniCharacter = createRPGCharacter(
          selectedAvatar.skinTone,
          selectedAvatar.outfit,
          selectedAvatar.hair,
          selectedAvatar.accessory === 'none' ? null : selectedAvatar.accessory
        );
        phinAvatar.innerHTML = miniCharacter;
      }
    }
    
    function closeModal() {
      document.getElementById('modal-overlay').classList.add('hidden');
    }
    
    function switchDictTab(tabName) {
      // Tab name mapping
      const tabMapping = {
        'learned': 'learned',
        'saved': 'saved',
        'slangs': 'slangs',
        'memes': 'meme pronunciation',
        'dictionary': 'dictionary'
      };

      // Update tab buttons
      const tabs = document.querySelectorAll('.dict-tab');
      tabs.forEach(tab => {
        const tabText = tab.textContent.toLowerCase();
        if (tabText === tabMapping[tabName]) {
          tab.classList.add('active');
        } else {
          tab.classList.remove('active');
        }
      });
      
      // Update tab content
      const tabContents = document.querySelectorAll('.dict-tab-content');
      tabContents.forEach(content => {
        if (content.id === `dict-tab-${tabName}`) {
          content.classList.remove('hidden');
        } else {
          content.classList.add('hidden');
        }
      });
      
      // Clear search
      document.getElementById('dict-search').value = '';
    }
    
    function searchDictionary() {
      const searchTerm = document.getElementById('dict-search').value.toLowerCase();
      const activeTab = document.querySelector('.dict-tab-content:not(.hidden)');
      const entries = activeTab.querySelectorAll('.word-entry, .dialogue-entry, .slang-entry, .meme-entry');
      
      entries.forEach(entry => {
        const text = entry.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
          entry.style.display = entry.classList.contains('word-entry') ? 'flex' : 'block';
        } else {
          entry.style.display = 'none';
        }
      });
    }
    
    function unsaveDialogue(index) {
      // Remove from savedDialogues array
      if (index >= 0 && index < savedDialogues.length) {
        savedDialogues.splice(index, 1);
        
        // Save to localStorage
        localStorage.setItem('savedDialogues', JSON.stringify(savedDialogues));
        
        // Update the saved tab display
        updateSavedTab();
      }
    }
    
    function moveNPC() {
      const npcs = [
        { id: 'npc1', startX: 20, startY: 20 },
        { id: 'npc2', startX: 60, startY: 40 },
        { id: 'npc3', startX: 50, startY: 60 },
        { id: 'npc4', startX: 65, startY: 25 }
      ];
      
      npcs.forEach(npc => {
        const element = document.getElementById(npc.id);
        if (element) {
          const randomOffsetX = (Math.random() - 0.5) * 60;
          const randomOffsetY = (Math.random() - 0.5) * 60;
          
          let newX = npc.startX + randomOffsetX;
          let newY = npc.startY + randomOffsetY;
          
          newX = Math.max(5, Math.min(95, newX));
          newY = Math.max(5, Math.min(95, newY));
          
          element.style.left = newX + '%';
          element.style.top = newY + '%';
        }
      });
    }
    
    function startNPCMovement() {
      moveNPC();
      setInterval(moveNPC, 3000);
    }
    
    let timerIntervals = {};
    
    function startCountdownTimers() {
      const timers = [
        { id: 'timer-market', totalSeconds: 9000 },
        { id: 'timer-restaurant', totalSeconds: 6300 },
        { id: 'timer-park', totalSeconds: 11700 }
      ];
      
      timers.forEach(timer => {
        let remainingSeconds = timer.totalSeconds;
        
        const hours = Math.floor(remainingSeconds / 3600);
        const minutes = Math.floor((remainingSeconds % 3600) / 60);
        const timeString = `-${hours}h:${minutes.toString().padStart(2, '0')}m`;
        const timerElement = document.getElementById(timer.id);
        if (timerElement) {
          timerElement.textContent = timeString;
        }

        timerIntervals[timer.id] = setInterval(() => {
          remainingSeconds--;

          if (remainingSeconds < 0) {
            remainingSeconds = timer.totalSeconds;
          }

          const hours = Math.floor(remainingSeconds / 3600);
          const minutes = Math.floor((remainingSeconds % 3600) / 60);
          const timeString = `-${hours}h:${minutes.toString().padStart(2, '0')}m`;

          const timerElement = document.getElementById(timer.id);
          if (timerElement) {
            timerElement.textContent = timeString;
          }
        }, 1000);
      });
    }
    
    // ========================================
    // SHOPPING GAME FUNCTIONS
    // ========================================

    let shoppingGameTimer;
    let shoppingTimeLeft = 30;
    let shoppingScore = 0;
    let selectedItems = [];
    let correctItems = [];

    const shoppingItems = [
      { chinese: 'ËòãÊûú', pinyin: 'p√≠nggu«í', english: 'apple', emoji: 'üçé' },
      { chinese: 'ÁâõÂ•∂', pinyin: 'ni√∫n«éi', english: 'milk', emoji: 'ü•õ' },
      { chinese: 'È∫µÂåÖ', pinyin: 'mi√†nbƒÅo', english: 'bread', emoji: 'üçû' },
      { chinese: 'ÈõûËõã', pinyin: 'jƒ´d√†n', english: 'eggs', emoji: 'ü•ö' },
      { chinese: 'È¶ôËïâ', pinyin: 'xiƒÅngjiƒÅo', english: 'banana', emoji: 'üçå' },
      { chinese: 'ËÉ°ËòøËîî', pinyin: 'h√∫lu√≥bo', english: 'carrot', emoji: 'ü•ï' },
      { chinese: 'ÈõûËÇâ', pinyin: 'jƒ´r√≤u', english: 'chicken', emoji: 'üçó' },
      { chinese: 'Ëµ∑Âè∏', pinyin: 'q«êsƒ´', english: 'cheese', emoji: 'üßÄ' },
      { chinese: 'Ë•øÁìú', pinyin: 'xƒ´guƒÅ', english: 'watermelon', emoji: 'üçâ' },
      { chinese: 'Áï™ËåÑ', pinyin: 'fƒÅnqi√©', english: 'tomato', emoji: 'üçÖ' }
    ];

    function openShoppingGame() {
      // Reset game state
      shoppingTimeLeft = 30;
      shoppingScore = 0;
      selectedItems = [];

      // Select 3 random items for shopping list
      const shuffled = [...shoppingItems].sort(() => Math.random() - 0.5);
      correctItems = shuffled.slice(0, 3);

      // Show all items in grid (correct + decoys)
      const allGameItems = shuffled.slice(0, 8);

      // Update UI
      document.getElementById('shopping-game-modal').classList.remove('hidden');
      document.getElementById('game-timer').textContent = shoppingTimeLeft;
      document.getElementById('game-score').textContent = shoppingScore;
      document.getElementById('game-result').style.display = 'none';

      // Render shopping list
      const listDiv = document.getElementById('shopping-list');
      listDiv.innerHTML = correctItems.map(item => `
        <div style="padding: 8px; background: white; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
          <span style="font-size: 18px; font-weight: 600;">${item.chinese}</span>
          <span style="font-size: 14px; color: #718096;">${item.pinyin}</span>
        </div>
      `).join('');

      // Render items grid
      const gridDiv = document.getElementById('items-grid');
      gridDiv.innerHTML = allGameItems.map((item, index) => `
        <div id="item-${index}" onclick="selectShoppingItem(${index}, '${item.chinese}')"
             style="background: #f7fafc; border: 3px solid #e2e8f0; border-radius: 12px; padding: 16px; cursor: pointer; transition: all 0.2s; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100px;"
             onmouseover="if(!this.classList.contains('selected')) this.style.transform='scale(1.05)'"
             onmouseout="this.style.transform='scale(1)'">
          <div style="font-size: 48px;">${item.emoji}</div>
        </div>
      `).join('');

      // Start timer
      clearInterval(shoppingGameTimer);
      shoppingGameTimer = setInterval(() => {
        shoppingTimeLeft--;
        document.getElementById('game-timer').textContent = shoppingTimeLeft;

        if (shoppingTimeLeft <= 0) {
          clearInterval(shoppingGameTimer);
          checkShoppingAnswers();
        }
      }, 1000);
    }

    function selectShoppingItem(index, itemChinese) {
      const itemDiv = document.getElementById(`item-${index}`);

      if (selectedItems.includes(itemChinese)) {
        // Deselect
        selectedItems = selectedItems.filter(i => i !== itemChinese);
        itemDiv.style.background = '#f7fafc';
        itemDiv.style.borderColor = '#e2e8f0';
        itemDiv.classList.remove('selected');
      } else {
        // Select
        selectedItems.push(itemChinese);
        itemDiv.style.background = '#c6f6d5';
        itemDiv.style.borderColor = '#48bb78';
        itemDiv.classList.add('selected');
      }
    }

    function checkShoppingAnswers() {
      clearInterval(shoppingGameTimer);

      const correctAnswers = correctItems.map(item => item.chinese);
      const correctCount = selectedItems.filter(item => correctAnswers.includes(item)).length;
      const wrongCount = selectedItems.filter(item => !correctAnswers.includes(item)).length;

      shoppingScore = (correctCount * 100) - (wrongCount * 50);

      // Award Gold based on score (only if score is positive)
      let yuanBaoEarned = 0;
      if (shoppingScore > 0) {
        yuanBaoEarned = shoppingScore;
        yuanBao += yuanBaoEarned;
        localStorage.setItem('yuanBao', yuanBao);
        document.getElementById('room-yuan-bao').textContent = yuanBao;
      document.getElementById('world-yuan-bao').textContent = yuanBao;
      }

      document.getElementById('game-score').textContent = shoppingScore;

      const resultDiv = document.getElementById('game-result');
      resultDiv.style.display = 'block';

      if (correctCount === correctAnswers.length && wrongCount === 0) {
        resultDiv.style.background = '#c6f6d5';
        resultDiv.style.color = '#22543d';
        resultDiv.innerHTML = `üéâ Perfect! You got all ${correctCount} items!<br>Score: ${shoppingScore}<br>üí∞ Gold earned: +${yuanBaoEarned}`;
      } else if (shoppingScore > 0) {
        resultDiv.style.background = '#fef5e7';
        resultDiv.style.color = '#7d6608';
        resultDiv.innerHTML = `‚úÖ Correct: ${correctCount} | ‚ùå Wrong: ${wrongCount}<br>Score: ${shoppingScore}<br>üí∞ Gold earned: +${yuanBaoEarned}`;
      } else {
        resultDiv.style.background = '#fed7d7';
        resultDiv.style.color = '#742a2a';
        resultDiv.innerHTML = `‚úÖ Correct: ${correctCount} | ‚ùå Wrong: ${wrongCount}<br>Score: ${shoppingScore}<br>üí∞ No Gold earned`;
      }

      document.getElementById('submit-btn').disabled = true;
      document.getElementById('submit-btn').style.opacity = '0.5';
    }

    function closeShoppingGame() {
      clearInterval(shoppingGameTimer);
      document.getElementById('shopping-game-modal').classList.add('hidden');
      document.getElementById('submit-btn').disabled = false;
      document.getElementById('submit-btn').style.opacity = '1';
    }

    // ========================================
    // RESTAURANT ORDERING GAME
    // ========================================
    const restaurantDishes = [
      { emoji: 'üçú', english: 'Noodles', sentence: ['Êàë', 'Ë¶Å', '‰∏Ä', 'Á¢ó', 'È∫µ'], pinyin: 'W«í y√†o yƒ´ w«én mi√†n' },
      { emoji: 'ü•ü', english: 'Dumplings', sentence: ['Êàë', 'ÊÉ≥', 'ÂêÉ', 'È§ÉÂ≠ê'], pinyin: 'W«í xi«éng chƒ´ ji«éozi' }
    ];

    let currentDish = null;
    let restaurantTimeLeft = 30;
    let restaurantScore = 0;
    let restaurantGameTimer = null;
    let builtSentence = [];
    let dishesCompleted = 0;
    let totalDishes = 2;

    function openRestaurantGame() {
      dishesCompleted = 0;
      restaurantScore = 0;
      restaurantTimeLeft = 30;
      builtSentence = [];

      document.getElementById('restaurant-game-modal').classList.remove('hidden');
      document.getElementById('restaurant-score').textContent = restaurantScore;

      loadNextDish();

      // Start timer
      clearInterval(restaurantGameTimer);
      restaurantGameTimer = setInterval(() => {
        restaurantTimeLeft--;
        document.getElementById('restaurant-timer').textContent = restaurantTimeLeft;

        if (restaurantTimeLeft <= 0) {
          clearInterval(restaurantGameTimer);
          endRestaurantGame();
        }
      }, 1000);
    }

    function loadNextDish() {
      if (dishesCompleted >= totalDishes) {
        endRestaurantGame();
        return;
      }

      // Select random dish
      currentDish = restaurantDishes[Math.floor(Math.random() * restaurantDishes.length)];
      builtSentence = [];

      // Display dish
      document.getElementById('current-dish').textContent = currentDish.emoji;
      document.getElementById('dish-name').textContent = currentDish.english;
      document.getElementById('restaurant-result').style.display = 'none';

      // Shuffle the sentence words
      const shuffledWords = [...currentDish.sentence].sort(() => Math.random() - 0.5);

      // Render word tiles
      const tilesDiv = document.getElementById('word-tiles');
      tilesDiv.innerHTML = shuffledWords.map((word, index) => `
        <div id="word-tile-${index}" onclick="addWordToSentence('${word}', ${index})"
             style="background: #f7fafc; border: 2px solid #cbd5e0; border-radius: 8px; padding: 12px 20px; cursor: pointer; font-size: 20px; font-weight: 600; color: #2d3748; transition: all 0.2s;"
             onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)'"
             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
          ${word}
        </div>
      `).join('');

      // Clear sentence builder
      document.getElementById('sentence-builder').innerHTML = '';
    }

    function addWordToSentence(word, tileIndex) {
      const tile = document.getElementById(`word-tile-${tileIndex}`);
      if (tile.style.opacity === '0.3') return; // Already used

      builtSentence.push(word);
      tile.style.opacity = '0.3';
      tile.style.pointerEvents = 'none';

      updateSentenceDisplay();
    }

    function updateSentenceDisplay() {
      const builderDiv = document.getElementById('sentence-builder');
      builderDiv.innerHTML = builtSentence.map((word, index) => `
        <div onclick="removeWordFromSentence(${index})"
             style="background: #e6fffa; border: 2px solid #4fd1c5; border-radius: 8px; padding: 10px 18px; cursor: pointer; font-size: 20px; font-weight: 600; color: #234e52; transition: all 0.2s;"
             onmouseover="this.style.background='#fef5e7'; this.style.borderColor='#f59e0b'"
             onmouseout="this.style.background='#e6fffa'; this.style.borderColor='#4fd1c5'">
          ${word}
        </div>
      `).join('');
    }

    function removeWordFromSentence(index) {
      const removedWord = builtSentence[index];
      builtSentence.splice(index, 1);

      // Re-enable the tile
      const tiles = document.getElementById('word-tiles').children;
      for (let i = 0; i < tiles.length; i++) {
        if (tiles[i].textContent.trim() === removedWord && tiles[i].style.opacity === '0.3') {
          tiles[i].style.opacity = '1';
          tiles[i].style.pointerEvents = 'auto';
          break;
        }
      }

      updateSentenceDisplay();
    }

    function clearSentence() {
      builtSentence = [];

      // Re-enable all tiles
      const tiles = document.getElementById('word-tiles').children;
      for (let tile of tiles) {
        tile.style.opacity = '1';
        tile.style.pointerEvents = 'auto';
      }

      updateSentenceDisplay();
    }

    function checkRestaurantAnswer() {
      const correctSentence = currentDish.sentence.join('');
      const userSentence = builtSentence.join('');

      const resultDiv = document.getElementById('restaurant-result');
      resultDiv.style.display = 'block';

      if (correctSentence === userSentence) {
        restaurantScore += 100;
        dishesCompleted++;

        resultDiv.style.background = '#c6f6d5';
        resultDiv.style.color = '#22543d';
        resultDiv.innerHTML = `‚úÖ Correct!<br><small style="font-size: 14px;">${currentDish.pinyin}</small><br>+100 points`;

        document.getElementById('restaurant-score').textContent = restaurantScore;

        // Load next dish after 1.5 seconds
        setTimeout(() => {
          loadNextDish();
        }, 1500);
      } else {
        restaurantScore -= 50;
        if (restaurantScore < 0) restaurantScore = 0;

        resultDiv.style.background = '#fed7d7';
        resultDiv.style.color = '#742a2a';
        resultDiv.innerHTML = `‚ùå Incorrect! Try again.<br><small style="font-size: 14px;">Correct: ${currentDish.sentence.join(' ')}</small>`;

        document.getElementById('restaurant-score').textContent = restaurantScore;
      }
    }

    function endRestaurantGame() {
      clearInterval(restaurantGameTimer);

      // Award Gold based on score (only if score is positive)
      let yuanBaoEarned = 0;
      if (restaurantScore > 0) {
        yuanBaoEarned = restaurantScore;
        yuanBao += yuanBaoEarned;
        localStorage.setItem('yuanBao', yuanBao);
        document.getElementById('room-yuan-bao').textContent = yuanBao;
      document.getElementById('world-yuan-bao').textContent = yuanBao;
      }

      const resultDiv = document.getElementById('restaurant-result');
      resultDiv.style.display = 'block';

      if (dishesCompleted === totalDishes) {
        resultDiv.style.background = '#c6f6d5';
        resultDiv.style.color = '#22543d';
        resultDiv.innerHTML = `üéâ All dishes ordered!<br>Score: ${restaurantScore}<br>üí∞ Gold earned: +${yuanBaoEarned}`;
      } else if (restaurantScore > 0) {
        resultDiv.style.background = '#fef5e7';
        resultDiv.style.color = '#7d6608';
        resultDiv.innerHTML = `‚è∞ Time's up!<br>Dishes completed: ${dishesCompleted}/${totalDishes}<br>Score: ${restaurantScore}<br>üí∞ Gold earned: +${yuanBaoEarned}`;
      } else {
        resultDiv.style.background = '#fed7d7';
        resultDiv.style.color = '#742a2a';
        resultDiv.innerHTML = `‚è∞ Time's up!<br>Dishes completed: ${dishesCompleted}/${totalDishes}<br>Score: ${restaurantScore}<br>üí∞ No Gold earned`;
      }

      document.getElementById('restaurant-submit-btn').disabled = true;
      document.getElementById('restaurant-submit-btn').style.opacity = '0.5';
      document.getElementById('word-tiles').innerHTML = '';
    }

    function closeRestaurantGame() {
      clearInterval(restaurantGameTimer);
      document.getElementById('restaurant-game-modal').classList.add('hidden');
      document.getElementById('restaurant-submit-btn').disabled = false;
      document.getElementById('restaurant-submit-btn').style.opacity = '1';
    }

    // ========================================
    // PARK FLASHCARD GAME
    // ========================================
    const flashcards = [
      { emoji: 'üë¶', chinese: 'Áî∑Â≠©', pinyin: 'n√°nh√°i', english: 'boy' },
      { emoji: 'üëß', chinese: 'Â•≥Â≠©', pinyin: 'n«öh√°i', english: 'girl' },
      { emoji: 'üë®', chinese: 'Áî∑‰∫∫', pinyin: 'n√°nr√©n', english: 'man' },
      { emoji: 'üë©', chinese: 'Â•≥‰∫∫', pinyin: 'n«ör√©n', english: 'woman' },
      { emoji: 'üë¥', chinese: 'ËÄÅ‰∫∫', pinyin: 'l«éor√©n', english: 'old man' },
      { emoji: 'üëµ', chinese: 'ËÄÅ‰∫∫', pinyin: 'l«éor√©n', english: 'old woman' },
      { emoji: 'üë∂', chinese: 'Â¨∞ÂÖí', pinyin: 'yƒ´ng√©r', english: 'baby' },
      { emoji: 'üë®‚Äç‚öïÔ∏è', chinese: 'ÈÜ´Áîü', pinyin: 'yƒ´shƒìng', english: 'doctor' },
      { emoji: 'üë®‚Äçüè´', chinese: 'ËÄÅÂ∏´', pinyin: 'l«éoshƒ´', english: 'teacher' },
      { emoji: 'üë®‚Äçüç≥', chinese: 'ÂªöÂ∏´', pinyin: 'ch√∫shƒ´', english: 'chef' }
    ];

    let parkTimeLeft = 15;
    let parkScore = 0;
    let parkGameTimer = null;
    let currentCard = null;
    let isCorrectCard = true;
    let cardsAnswered = 0;
    let parkGameActive = false;

    function openParkGame() {
      parkTimeLeft = 15;
      parkScore = 0;
      cardsAnswered = 0;
      parkGameActive = true;

      document.getElementById('park-game-modal').classList.remove('hidden');
      document.getElementById('park-timer').textContent = parkTimeLeft;
      document.getElementById('park-score').textContent = parkScore;
      document.getElementById('park-result').style.display = 'none';
      document.getElementById('park-result-backdrop').style.display = 'none';

      loadNextCard();

      // Start timer
      clearInterval(parkGameTimer);
      parkGameTimer = setInterval(() => {
        parkTimeLeft--;
        document.getElementById('park-timer').textContent = parkTimeLeft;

        if (parkTimeLeft <= 0) {
          clearInterval(parkGameTimer);
          endParkGame();
        }
      }, 1000);
    }

    function loadNextCard() {
      if (!parkGameActive) return;

      // Random card
      currentCard = flashcards[Math.floor(Math.random() * flashcards.length)];

      // 50% chance to show correct or wrong answer
      isCorrectCard = Math.random() > 0.5;

      document.getElementById('card-emoji').textContent = currentCard.emoji;

      if (isCorrectCard) {
        // Show correct Chinese word
        document.getElementById('card-chinese').textContent = currentCard.chinese;
        document.getElementById('card-pinyin').textContent = currentCard.pinyin;
      } else {
        // Show wrong Chinese word (pick a different card's word)
        let wrongCard;
        do {
          wrongCard = flashcards[Math.floor(Math.random() * flashcards.length)];
        } while (wrongCard.chinese === currentCard.chinese);

        document.getElementById('card-chinese').textContent = wrongCard.chinese;
        document.getElementById('card-pinyin').textContent = wrongCard.pinyin;
      }

      // Reset card animation
      const card = document.getElementById('flashcard');
      card.style.transform = 'scale(1)';
      card.style.opacity = '1';
    }

    function swipeLeft() {
      if (!parkGameActive) return;

      // Swipe left = Wrong answer
      if (!isCorrectCard) {
        // Correct! The card was indeed wrong
        parkScore += 50;
        animateCard('left', true);
      } else {
        // Incorrect! The card was actually correct
        parkScore -= 25;
        if (parkScore < 0) parkScore = 0;
        animateCard('left', false);
      }

      document.getElementById('park-score').textContent = parkScore;
      cardsAnswered++;

      setTimeout(() => {
        if (parkGameActive) loadNextCard();
      }, 500);
    }

    function swipeRight() {
      if (!parkGameActive) return;

      // Swipe right = Correct answer
      if (isCorrectCard) {
        // Correct! The card was indeed correct
        parkScore += 50;
        animateCard('right', true);
      } else {
        // Incorrect! The card was actually wrong
        parkScore -= 25;
        if (parkScore < 0) parkScore = 0;
        animateCard('right', false);
      }

      document.getElementById('park-score').textContent = parkScore;
      cardsAnswered++;

      setTimeout(() => {
        if (parkGameActive) loadNextCard();
      }, 500);
    }

    function animateCard(direction, correct) {
      const card = document.getElementById('flashcard');
      const rotation = direction === 'left' ? -30 : 30;
      const translateX = direction === 'left' ? -500 : 500;

      // Add visual feedback
      if (correct) {
        card.style.boxShadow = '0 0 30px rgba(72, 187, 120, 0.8)';
      } else {
        card.style.boxShadow = '0 0 30px rgba(255, 68, 68, 0.8)';
      }

      card.style.transform = `translateX(${translateX}px) rotate(${rotation}deg)`;
      card.style.opacity = '0';
    }

    function endParkGame() {
      parkGameActive = false;
      clearInterval(parkGameTimer);

      // Award Gold based on score (only if score is positive)
      let yuanBaoEarned = 0;
      if (parkScore > 0) {
        yuanBaoEarned = parkScore;
        yuanBao += yuanBaoEarned;
        localStorage.setItem('yuanBao', yuanBao);
        document.getElementById('room-yuan-bao').textContent = yuanBao;
      document.getElementById('world-yuan-bao').textContent = yuanBao;
      }

      const resultDiv = document.getElementById('park-result');
      resultDiv.style.display = 'block';
      document.getElementById('park-result-backdrop').style.display = 'block';

      if (parkScore >= 300) {
        resultDiv.style.background = '#c6f6d5';
        resultDiv.style.color = '#22543d';
        resultDiv.innerHTML = `
          üéâ Amazing!<br>Cards: ${cardsAnswered} | Score: ${parkScore}<br>üí∞ Gold earned: +${yuanBaoEarned}<br>
          <button onclick="openLeaderboard()" style="margin-top: 16px; padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">üèÜ Check My Ranking</button>
        `;
      } else if (parkScore > 0) {
        resultDiv.style.background = '#fef5e7';
        resultDiv.style.color = '#7d6608';
        resultDiv.innerHTML = `
          ‚è∞ Time's up!<br>Cards: ${cardsAnswered} | Score: ${parkScore}<br>üí∞ Gold earned: +${yuanBaoEarned}<br>
          <button onclick="openLeaderboard()" style="margin-top: 16px; padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">üèÜ Check My Ranking</button>
        `;
      } else {
        resultDiv.style.background = '#fed7d7';
        resultDiv.style.color = '#742a2a';
        resultDiv.innerHTML = `
          ‚è∞ Time's up!<br>Cards: ${cardsAnswered} | Score: ${parkScore}<br>üí∞ No Gold earned<br>
          <button onclick="openLeaderboard()" style="margin-top: 16px; padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">üèÜ Check My Ranking</button>
        `;
      }

      document.getElementById('swipe-left-btn').disabled = true;
      document.getElementById('swipe-right-btn').disabled = true;
      document.getElementById('swipe-left-btn').style.opacity = '0.5';
      document.getElementById('swipe-right-btn').style.opacity = '0.5';
    }

    function closeParkGame() {
      parkGameActive = false;
      clearInterval(parkGameTimer);
      document.getElementById('park-game-modal').classList.add('hidden');
      document.getElementById('swipe-left-btn').disabled = false;
      document.getElementById('swipe-right-btn').disabled = false;
      document.getElementById('swipe-left-btn').style.opacity = '1';
      document.getElementById('swipe-right-btn').style.opacity = '1';
    }

    // ========================================
    // LEADERBOARD
    // ========================================
    function generateRandomUsername() {
      const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
      const length = 6;
      let username = '';
      for (let i = 0; i < length; i++) {
        username += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return username;
    }

    function openLeaderboard() {
      document.getElementById('leaderboard-modal').classList.remove('hidden');

      // Generate random ranking between 4-9
      const userRanking = Math.floor(Math.random() * 6) + 4; // Random between 4-9
      const totalPlayers = 11;

      // Calculate scores
      const userScore = parkScore;
      const aboveScore = userScore + 25;
      const belowScore = Math.max(0, userScore - 50); // Never go below 0

      const playerAbove = {
        rank: userRanking - 1,
        name: generateRandomUsername(),
        avatar: 'üë§',
        score: aboveScore
      };

      const currentUser = {
        rank: userRanking,
        name: username,
        avatar: 'üë§',
        score: userScore,
        isCurrentUser: true
      };

      const playerBelow = {
        rank: userRanking + 1,
        name: generateRandomUsername(),
        avatar: 'üë§',
        score: belowScore
      };

      // Build leaderboard HTML
      const leaderboardContent = document.getElementById('leaderboard-content');
      leaderboardContent.innerHTML = `
        <div style="margin-bottom: 16px; text-align: center; color: #718096; font-size: 14px;">
          Total Players: ${totalPlayers}
        </div>
        ${renderLeaderboardRow(playerAbove)}
        <div style="margin: 8px 0 12px 0; text-align: center; color: #718096; font-size: 13px; font-style: italic;">
          So Close! Try Again!
        </div>
        ${renderLeaderboardRow(currentUser)}
        ${renderLeaderboardRow(playerBelow)}
        <button onclick="restartParkGame()" style="width: 100%; margin-top: 24px; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">üîÑ One More Try!</button>
      `;
    }

    function renderLeaderboardRow(player) {
      const bgColor = player.isCurrentUser ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : '#f7fafc';
      const textColor = player.isCurrentUser ? 'white' : '#2d3748';
      const rankColor = player.isCurrentUser ? '#ffd700' : '#718096';

      return `
        <div style="background: ${bgColor}; padding: 16px 20px; border-radius: 12px; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <div style="display: flex; align-items: center; gap: 16px; flex: 1;">
            <div style="font-size: 24px; font-weight: 700; color: ${rankColor}; min-width: 30px;">
              #${player.rank}
            </div>
            <div style="font-size: 32px;">
              ${player.avatar}
            </div>
            <div style="flex: 1;">
              <div style="font-size: 16px; font-weight: 700; color: ${textColor};">
                ${player.name}${player.isCurrentUser ? ' (You)' : ''}
              </div>
            </div>
          </div>
          <div style="font-size: 20px; font-weight: 700; color: ${textColor};">
            ${player.score} pts
          </div>
        </div>
      `;
    }

    function closeLeaderboard() {
      document.getElementById('leaderboard-modal').classList.add('hidden');
    }

    function openDatingTips() {
      document.getElementById('dating-tips-modal').classList.remove('hidden');
    }

    function closeDatingTips() {
      document.getElementById('dating-tips-modal').classList.add('hidden');
    }

    function restartParkGame() {
      // Close both modals
      closeLeaderboard();
      closeParkGame();
      // Restart the game
      setTimeout(() => {
        openParkGame();
      }, 100);
    }

    const savedUsername = localStorage.getItem('username');
    if (savedUsername) {
      username = savedUsername;
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('main-app').classList.remove('hidden');
      initializeAllIcons();
      loadUserData();
      startNPCMovement();
      startCountdownTimers();
      initializeLessonMap();
      showLessonSelection();
      updateAvatarDisplay();
      updateSavedTab();
    }
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9ad73ba4643ca9c2',t:'MTc2NTY0NzQ4NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>